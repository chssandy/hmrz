<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hmrz.mybatis.dbrecord">
		
	<select id="getTradeList" parameterType="DBTradeSearch" resultType="DBTradeBean">
		select trade_type_id,name from db_trade_type 
		<where>
			<if test="father_id !=null and father_id !=''">
				father_id = #{father_id}
			</if>
			<if test="level !=null and level !=''">
				level = #{level}
			</if>
		</where>
	</select>
	
	
	<insert id="addDBRecord" parameterType="DBRecordBean" useGeneratedKeys="true" keyProperty="record_id">
		insert into db_record(vendor_space_id,theme,brand,trade,first_trade,monitor_time,imgs,
		task_biz,task_id,execute_id,is_illegal,illegal_reason,create_user
		<if test="area_tag != '' and area_tag != null">
		  ,tag_area
		</if>
		<if test="special_tag != '' and special_tag != null">
          ,tag_special
        </if>
		)
		values(#{vendor_space_id},#{theme},#{brand},#{trade},#{father_trade},#{monitor_time},#{imgs},
		#{task_biz},#{task_id},#{execute_id},#{is_illegal},#{illegal_reason},#{operator}
		<if test="area_tag != '' and area_tag != null">
          ,#{area_tag}
        </if>
        <if test="special_tag != '' and special_tag != null">
          ,#{special_tag}
        </if>
        )
	</insert>
	
	<delete id="delSpaceRecord" parameterType="String">
		delete dr.*  from db_record dr where dr.record_id = #{record_id} 
	</delete>
	
	<delete id="deleteDBRecord" parameterType="String">
		delete from db_record where vendor_space_id = #{vendor_space_id}
	</delete>
	
	<insert id="addDBIllegal" parameterType="HashMap">
		insert into db_record_illegal (record_id,illegal_code,illegal_level) values
		<foreach collection="illegals" item="item" separator="," index="index">
			(#{record_id},#{item.illegal_code},#{item.illegal_level})
        </foreach>
	</insert>
	
	
	<select id="getDBRecordList" parameterType="DBRecordSearch" resultType="DBRecordBean">
		SELECT dr.record_id,dr.theme,dr.vendor_space_id,ds.space_id,ds.`name`, 
			(select CONCAT(dmt1.name,"-",dmt.name) from db_media_type dmt  left join db_media_type dmt1 on dmt.father_id = dmt1.media_type_id
						where ds.type = dmt.media_type_id) as media_name,
				dv.vendor_name,
				sb.brand_name,
				dr.brand,
			(select CONCAT(dtt1.name,"-",dtt.name) from db_trade_type dtt  left join db_trade_type dtt1 on dtt.father_id = dtt1.trade_type_id
						where dr.trade = dtt.trade_type_id) as trade_name,
			DATE_FORMAT(dr.monitor_time,'%Y-%m-%d') as monitor_time,
			dr.imgs,dr.is_illegal,dr.task_biz,dr.task_id,dr.execute_id,dr.illegal_reason,xm.manager_name as operator
			<if test='is_export == "1"' >
				,e_illegal_level,e_illegal_code,e_normal,e_serious
			</if>
		FROM db_record dr 
		LEFT JOIN db_vendor_space dsv on dr.vendor_space_id = dsv.vendor_space_id
		LEFT JOIN db_space ds on dsv.space_id = ds.space_id
		LEFT JOIN db_vendor dv ON dsv.vendor_id = dv.vendor_id
		left join xt_manager xm on dr.create_user = xm.manager_id
		left join s_brand sb on dr.brand = sb.brand_id
		<if test='is_export == "1"'>
			LEFT JOIN 
			(select record_id,
				GROUP_CONCAT(IF(illegal_level=0,"一般违法","严重违法")) e_illegal_level,
				GROUP_CONCAT(illegal_code) e_illegal_code,
				SUM(IF(illegal_level=0,1,0)) e_normal,
				SUM(IF(illegal_level=1,1,0)) e_serious 
				from db_record_illegal group by record_id) A ON A.record_id = dr.record_id
		</if>
		 <where>
		 	<if test="theme !='' and theme !=null">
		 		dr.theme LIKE CONCAT("%",#{theme},"%") AND
		 	</if>
		 	<if test="brand !='' and brand !=null">
		 		sb.brand_name LIKE CONCAT("%",#{brand},"%") AND
		 	</if>
		 	<if test="trade !='' and trade !=null and trade !='-1' ">
		 		dr.trade = #{trade}  AND
		 	</if>
		 	<if test="father_trade !='' and father_trade !=null and father_trade !='-1' ">
		 		dr.first_trade = #{father_trade}  AND
		 	</if>
		 	<if test="is_illegal !='' and is_illegal !=null and is_illegal !='-1' ">
		 		dr.is_illegal = #{is_illegal}  AND
		 	</if>
		 	<if test="monitor_btime != null and monitor_btime != ''">
                dr.monitor_time &gt;= CONCAT(#{monitor_btime}, ' 00:00:00') AND
            </if>
            <if test="monitor_etime != null and monitor_etime != ''">
                dr.monitor_time &lt;= CONCAT(#{monitor_etime}, ' 23:59:59') AND
            </if>
            <if test="space_id !='' and space_id !=null ">
		 		ds.space_id = #{space_id}  AND
		 	</if>
		 	<if test="vendor_id !='' and vendor_id !=null and vendor_id !='-1' ">
		 		dv.vendor_id = #{vendor_id}  AND
		 	</if>
		 	<if test="type !='' and type !=null and type !='-1' ">
		 		ds.type = #{type}  AND
		 	</if>
		 	<if test="father_type !='' and father_type !=null and father_type !='-1' ">
		 		ds.first_type = #{father_type}  AND
		 	</if>
		 	<if test="vendor_space_id !='' and vendor_space_id !=null  ">
		 		dsv.vendor_space_id = #{vendor_space_id}  AND
		 	</if>
		 	<if test="operator !='' and operator !=null">
		 		xm.manager_name LIKE CONCAT("%",#{operator},"%") AND
		 	</if>
            1=1
		 </where>
		 order by  dr.record_id desc
		 <if test="havePage == 1">
            LIMIT #{start},#{rows}
        </if>
	</select>
	
	<select id="getDBRecordCount" parameterType="DBRecordSearch" resultType="int">
		SELECT count(1)
		FROM db_record dr 
		LEFT JOIN db_vendor_space dsv on dr.vendor_space_id = dsv.vendor_space_id
		LEFT JOIN db_space ds on dsv.space_id = ds.space_id
		LEFT JOIN db_vendor dv ON dsv.vendor_id = dv.vendor_id
		left join xt_manager xm on dr.create_user = xm.manager_id
		left join s_brand sb on dr.brand = sb.brand_id
		 <where>
		 		<if test="theme !='' and theme !=null">
		 		dr.theme LIKE CONCAT("%",#{theme},"%") AND
		 	</if>
		 	<if test="brand !='' and brand !=null">
		 		sb.brand_name LIKE CONCAT("%",#{brand},"%") AND
		 	</if>
		 	<if test="trade !='' and trade !=null and trade !='-1' ">
		 		dr.trade = #{trade}  AND
		 	</if>
		 	<if test="father_trade !='' and father_trade !=null and father_trade !='-1' ">
		 		dr.first_trade = #{father_trade}  AND
		 	</if>
		 	<if test="is_illegal !='' and is_illegal !=null and is_illegal !='-1' ">
		 		dr.is_illegal = #{is_illegal}  AND
		 	</if>
		 	<if test="monitor_btime != null and monitor_btime != ''">
                dr.monitor_time &gt;= CONCAT(#{monitor_btime}, ' 00:00:00') AND
            </if>
            <if test="monitor_etime != null and monitor_etime != ''">
                dr.monitor_time &lt;= CONCAT(#{monitor_etime}, ' 23:59:59') AND
            </if>
            <if test="space_id !='' and space_id !=null ">
		 		ds.space_id = #{space_id}  AND
		 	</if>
		 	<if test="vendor_id !='' and vendor_id !=null and vendor_id !='-1' ">
		 		dv.vendor_id = #{vendor_id}  AND
		 	</if>
		 	<if test="type !='' and type !=null and type !='-1' ">
		 		ds.type = #{type}  AND
		 	</if>
		 	<if test="father_type !='' and father_type !=null and father_type !='-1' ">
		 		ds.first_type = #{father_type}  AND
		 	</if>
		 	<if test="vendor_space_id !='' and vendor_space_id !=null  ">
		 		dsv.vendor_space_id = #{vendor_space_id}  AND
		 	</if>
		 	<if test="operator !='' and operator !=null">
		 		xm.manager_name LIKE CONCAT("%",#{operator},"%") AND
		 	</if>
            1=1
		 </where>
	</select>
	
	<select id="getDBRecordByID" parameterType="int" resultType="DBRecordBean">
		select 
			dvs.vendor_space_id,
			dr.record_id,
			ds.space_id,
			dr.theme,
			dr.brand,
			sb.brand_name,
			dr.trade,
			first_trade as father_trade,
			DATE_FORMAT(dr.monitor_time,'%Y-%m-%d') as monitor_time,
			dr.imgs,
			dr.task_biz,
			dr.task_id,
			dr.execute_id,
			dr.is_illegal,
			dr.illegal_reason,
			ds.name,
			dv.vendor_name,
			dr.tag_area AS area_tag,
			dr.tag_special AS special_tag
			from db_record dr left join db_vendor_space dvs on dr.vendor_space_id = dvs.vendor_space_id
			left join db_space ds on dvs.space_id = ds.space_id
			left join db_vendor dv on dvs.vendor_id = dv.vendor_id
			left join s_brand sb on dr.brand = sb.brand_id
			where dr.record_id = #{record_id}
	</select>
	
	<select id="getIllegalList" parameterType="string" resultType="DBIllegalBean">
		select record_illegal_id,record_id,illegal_code,illegal_level,create_time from db_record_illegal where record_id = #{record_id}
	</select>
	
	<delete id="delIllegal" parameterType="string">
		delete from db_record_illegal where record_id = #{record_id}
	</delete>
	
	
	<update id="updateDBRecord" parameterType="DBRecordBean">
		update db_record 
		<set>
			theme = #{theme},
			brand = #{brand},
			trade = #{trade},
			first_trade = #{father_trade},
			monitor_time = #{monitor_time},
			imgs = #{imgs},
			task_biz = #{task_biz},
			task_id = #{task_id},
			execute_id = #{execute_id},
			is_illegal = #{is_illegal},
			illegal_reason = #{illegal_reason},
			update_user=#{operator},
	        tag_area = #{area_tag},
	        tag_special = #{special_tag}
		</set>
		where record_id = #{record_id}
	</update>
	
</mapper>