<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hmrz.mybatis.sharewxResult">
    
	<select id="getSharewxResultList"  parameterType="SharewxResultSearch" resultType="SharewxResultBean">
		SELECT 
			ssw.task_id,
			ssw.name, 
			ssw.vendor_id,
			cv.vendor_name,
			ssw.create_user,
			(select cc.moble from c_customer cc where cc.customer_id = ssw.create_user) as create_user_name,
			ssw.agent,
			(select xm.manager_name from xt_manager xm where xm.manager_id = ssw.agent) as agent_name,
			ssw.create_time as publish_time,
			ssw.execute_times,
			ssw.salary,
			ssw.plat_fee,
			ssw.status,
			ssw.remark,
			(select count(*) from s_share_wx_execute sswe where sswe.task_id = ssw.task_id) as sv,
			(select count(*) from s_share_wx_data sswd where sswd.task_id = ssw.task_id) as pv,
			(select count(*) from s_share_wx_data sswd where sswd.task_id = ssw.task_id and sswd.click_salary>0) as uv,
			ssw.do_btime,
			ssw.do_etime
		FROM
			s_share_wx ssw ,c_vendor cv
		WHERE ssw.vendor_id = cv.vendor_id 
		AND ssw.status &gt; 1 and ssw.status &lt; 6 AND ssw.status &lt;&gt; 3
   		<if test="task_id != null and task_id != ''">
			and ssw.task_id = #{task_id}
		</if>
    	<if test="name != null and name != ''">
			and ssw.name LIKE CONCAT('%',#{name},'%') 
		</if>
		<if test="vendor_name != null and vendor_name != ''">
			and ssw.vendor_name LIKE CONCAT('%',#{vendor_name},'%') 
		</if>
		<if test="status != null and status != '' and status !='-1'">
			and ssw.status = #{status}
		</if>
	    order by ssw.create_time,ssw.task_id desc
	    <if test="havePage == 1">
            limit #{start},#{rows}
        </if>
	</select>
	
	<select id="getSharewxResultCount" parameterType="SharewxResultSearch" resultType="int" >
	   	select count(1)
		from  s_share_wx ssw,c_vendor cv
		where ssw.vendor_id = cv.vendor_id
		AND ssw.status &gt; 1 and ssw.status &lt; 6 AND ssw.status &lt;&gt; 3
   		<if test="task_id != null and task_id != ''">
			and ssw.task_id = #{task_id}
		</if>
    	<if test="name != null and name != ''">
			and ssw.name LIKE CONCAT('%',#{name},'%') 
		</if>
		<if test="vendor_name != null and vendor_name != ''">
			and ssw.vendor_name LIKE CONCAT('%',#{vendor_name},'%') 
		</if>
		<if test="status != null and status != '' and status !='-1'">
			and ssw.status = #{status}
		</if>
		and ssw.is_del = 0 
	</select>
	
	<select id="listProvinceShareData" parameterType="SharewxResultSearch" resultType="ShareWXChartDataBean">
		SELECT
		  COUNT(*) AS value,
		  xc.province_name AS name,
		  xc.province_code AS code
		FROM s_share_wx_execute sswe,
		     xt_city xc
		WHERE sswe.task_id = #{task_id}
		AND sswe.exe_city = xc.city_code
		AND xc.city_level = 4
		GROUP BY xc.province_code
	</select>
	
	<select id="listCityShareData" parameterType="SharewxResultSearch" resultType="ShareWXChartDataBean">
		SELECT
		  COUNT(*) AS value,
		  xc.city_code AS code,
		  xc.city_name AS name
		FROM s_share_wx_execute sswe,
		     xt_city xc
		WHERE sswe.exe_city = xc.city_code
		AND sswe.task_id = #{task_id}
		AND xc.city_level = 4
		AND xc.province_code = #{province_code}
		GROUP BY xc.city_code
	</select>
	
	<select id="listProvinceClickData" parameterType="SharewxResultSearch" resultType="ShareWXChartDataBean">
		SELECT
		  COUNT(*) AS value,
		  xc.province_name AS name,
		  xc.province_code AS code
		FROM s_share_wx_execute sswe,
		     s_share_wx_data sswd,
		     xt_city xc
		WHERE sswe.task_id = #{task_id}
		AND sswe.execute_id = sswd.execute_id
		AND sswe.exe_city = xc.city_code
		AND xc.city_level = 4
		GROUP BY xc.province_code
	</select>
	
	<select id="listCityClickData" parameterType="SharewxResultSearch" resultType="ShareWXChartDataBean">
		SELECT
		  COUNT(*) AS value,
		  xc.city_code AS code,
		  xc.city_name AS name
		FROM s_share_wx_execute sswe,
		     s_share_wx_data sswd,
		     xt_city xc
		WHERE sswe.task_id = #{task_id}
		AND sswe.execute_id = sswd.execute_id
		AND sswe.exe_city = xc.city_code
		AND xc.city_level = 4
		AND xc.province_code = #{province_code}
		GROUP BY xc.city_code
	</select>
	
	<select id="listClickDataOfDay" parameterType="SharewxResultSearch" resultType="ShareWXLineChartPointBean">
		SELECT
		  DATE_FORMAT(sswd.click_time, '%Y/%m/%d') date,
		  COUNT(*) AS value
		FROM s_share_wx_data sswd,
		     s_share_wx ssw
		WHERE sswd.task_id = ssw.task_id
		AND sswd.task_id = #{task_id}
		AND sswd.click_time >= ssw.do_btime
		AND sswd.click_time &lt;= ssw.do_etime
		GROUP BY date
	</select>
	
	<select id="listPaidClickDataOfDay" parameterType="SharewxResultSearch" resultType="ShareWXLineChartPointBean">
		SELECT
		  DATE_FORMAT(sswd.click_time, '%Y/%m/%d') date,
		  COUNT(*) AS value
		FROM s_share_wx_data sswd,
		     s_share_wx ssw
		WHERE sswd.task_id = ssw.task_id
		AND sswd.task_id = #{task_id}
		AND sswd.click_salary > 0
		AND sswd.click_time >= ssw.do_btime
		AND sswd.click_time &lt;= ssw.do_etime
		GROUP BY date
	</select>
	
	<select id="listSalaryDataOfDay" parameterType="SharewxResultSearch" resultType="ShareWXLineChartPointBean">
		SELECT
		  DATE_FORMAT(sswd.click_time, '%Y/%m/%d') date,
		  SUM(sswd.click_salary) AS value
		FROM s_share_wx_data sswd,
		     s_share_wx ssw
		WHERE sswd.task_id = ssw.task_id
		AND sswd.task_id = #{task_id}
		AND sswd.click_salary > 0
		AND sswd.click_time >= ssw.do_btime
		AND sswd.click_time &lt;= ssw.do_etime
		GROUP BY date
	</select>
	
	<select id="countDetail" parameterType="SharewxResultSearch" resultType="int">
		SELECT count(1) FROM 
		(SELECT * FROM
				(SELECT (SELECT AU.moble FROM APP_USER AU WHERE AU.user_id = SSWU.user_id)
					 AS sharer
				 FROM S_SHARE_WX_EXECUTE SSWU
				 WHERE SSWU.task_id = #{task_id}
				) as T
			    GROUP BY T.sharer 
		) as TT;
	</select>
	
	<select id="listDetail" parameterType="SharewxResultSearch" resultType="SharewxResultBean">
		SELECT
		  SSWU.task_id,
		  SSWU.user_id as executor,
		  (SELECT SSW.salary FROM S_SHARE_WX SSW WHERE SSW.task_id = SSWU.task_id) AS salary,
		  (SELECT
		      AU.moble
		    FROM APP_USER AU
		    WHERE AU.user_id = SSWU.user_id) AS executor_name,
		  SSWU.share_time as execute_time,
		  count(sswu.task_id) as sv,
		  (select COUNT(sswd2.click_id) from S_SHARE_WX_DATA sswd2 where sswd2.user_id = SSWU.user_id AND sswd2.task_id = SSWU.task_id) AS pv,
		  (select IFNULL(sum(case when sswd1.click_salary > 0 then 1 else 0 end),0) from S_SHARE_WX_DATA sswd1 where sswd1.user_id = SSWU.user_id AND sswd1.task_id = SSWU.task_id) as uv
		FROM s_share_wx_execute SSWU
		where SSWU.task_id = #{task_id}
		GROUP BY executor
		ORDER BY SSWU.share_time DESC
		<if test="havePage == 1">
        	LIMIT #{start} , #{rows}
        </if>
	</select>
</mapper>