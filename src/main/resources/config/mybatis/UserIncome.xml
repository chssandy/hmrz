<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hmrz.mybatis.userIncome">

	<insert id="addUserIncome" parameterType="UserIncomeBean" useGeneratedKeys="true" keyProperty="income_id">
		insert into APP_USER_INCOME(
			user_id,task_biz,task_type,income,task_id,task_name) 
		values(#{user_id},#{task_biz},#{task_type},#{income},#{task_id},#{task_name})
	</insert>

	
	
	<!-- 用户收支明细列表 -->
	<select id="getBalanceOfPaymentList" parameterType="UserSearch" resultType="UserBalanceOfPaymentBean">
		select 
			au.user_id,
			au.moble,
			au.nick_name,
			(select IFNULL(sum(income),0)  from app_user_income aui where user_id = au.user_id AND task_biz = 1 AND type = 0 
				<if test="create_btime != null and create_btime !='' ">
				 	AND aui.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
				</if>
				<if test="create_etime != null and create_etime !='' ">
				 	AND aui.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
				</if>
			) as  monitor_income,
			(select IFNULL(sum(income),0)  from app_user_income aui where user_id = au.user_id AND task_biz = 3 AND type = 0
				<if test="create_btime != null and create_btime !='' ">
				 	AND aui.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
				</if>
				<if test="create_etime != null and create_etime !='' ">
				 	AND aui.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
				</if>
			) as  media_income,
			(select IFNULL(sum(income),0)  from app_user_income aui where user_id = au.user_id AND task_biz = 4 AND type = 0
				<if test="create_btime != null and create_btime !='' ">
				 	AND aui.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
				</if>
				<if test="create_etime != null and create_etime !='' ">
				 	AND aui.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
				</if>
			) as  inspecte_income,
			(select IFNULL(sum(income),0)  from app_user_income aui where user_id = au.user_id AND task_biz = 5 AND type = 0
				<if test="create_btime != null and create_btime !='' ">
				 	AND aui.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
				</if>
				<if test="create_etime != null and create_etime !='' ">
				 	AND aui.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
				</if>
			) as  collect_income,
			(select IFNULL(sum(income),0)  from app_user_income aui where user_id = au.user_id AND task_biz = 2 AND type = 0
				<if test="create_btime != null and create_btime !='' ">
				 	AND aui.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
				</if>
				<if test="create_etime != null and create_etime !='' ">
				 	AND aui.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
				</if>
			) as  sharewx_income,
			(select IFNULL(sum(income),0)  from app_user_income aui where user_id = au.user_id AND task_biz = 6 AND type = 0
				<if test="create_btime != null and create_btime !='' ">
				 	AND aui.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
				</if>
				<if test="create_etime != null and create_etime !='' ">
				 	AND aui.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
				</if>
			) as  survey_income,
			(select IFNULL(sum(income),0)  from app_user_income aui where user_id = au.user_id AND task_biz = 7 AND type = 0
				<if test="create_btime != null and create_btime !='' ">
				 	AND aui.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
				</if>
				<if test="create_etime != null and create_etime !='' ">
				 	AND aui.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
				</if>
			) as  report_income,
			(select IFNULL(sum(income),0)  from app_user_income aui where user_id = au.user_id AND task_biz = 8 AND type = 0
				<if test="create_btime != null and create_btime !='' ">
				 	AND aui.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
				</if>
				<if test="create_etime != null and create_etime !='' ">
				 	AND aui.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
				</if>
			) as supervise_income,
			(select IFNULL(sum(ac.denomination),0) from app_coupon ac where ac.is_used = 1 and ac.user_id = au.user_id
				<if test="create_btime != null and create_btime !='' ">
				 	AND ac.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
				</if>
				<if test="create_etime != null and create_etime !='' ">
				 	AND ac.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
				</if>
			) as  coupon_income,
			(select IFNULL(sum(balance_num),0)  from app_user_balance aub where balance_user = au.user_id AND type = 0 AND status &lt; 3
				<if test="create_btime != null and create_btime !='' ">
				 	AND aub.audit_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
				</if>
				<if test="create_etime != null and create_etime !='' ">
				 	AND aub.audit_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
				</if>
			) as withdraw_income,
			(select IFNULL(sum(handling_charge),0)  from app_user_balance aub where balance_user = au.user_id AND type = 0 AND status &lt; 3
				<if test="create_btime != null and create_btime !='' ">
				 	AND aub.audit_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
				</if>
				<if test="create_etime != null and create_etime !='' ">
				 	AND aub.audit_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
				</if>
			) as plat_fee,
			(select IFNULL(sum(balance_num),0)  from app_user_balance aub where balance_user = au.user_id AND type = 1 AND status &lt; 3
				<if test="create_btime != null and create_btime !='' ">
				 	AND aub.audit_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
				</if>
				<if test="create_etime != null and create_etime !='' ">
				 	AND aub.audit_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
				</if>	
			) as recharge_income,
		  	au.balance,
		  	(select (monitor_income+media_income+inspecte_income+collect_income+sharewx_income+survey_income+coupon_income) = 
				(withdraw_income+plat_fee+recharge_income+balance)
			) as is_balance
		  
		FROM app_user au
		WHERE 	au.is_del = 0
			<if test="moble_search != null and moble_search != ''">
                AND au.moble = #{moble_search}
            </if>
            <if test="nick_name_search != null and nick_name_search != ''">
                AND au.nick_name like concat('%', #{nick_name_search},'%')
            </if>
            ORDER BY au.user_id 
	        <if test="havePage == 1">
	        	LIMIT #{start} , #{rows}
	        </if>
	</select>
	
	<select id="getBalanceOfPaymentCount" parameterType="UserSearch" resultType="int">
        SELECT
        	count(1)
        FROM 
        	app_user au
        WHERE
           	au.is_del = 0
            <if test="moble_search != null and moble_search != ''">
                AND au.moble = #{moble_search}
            </if>
            <if test="nick_name_search != null and nick_name_search != ''">
                AND au.nick_name like concat('%', #{nick_name_search},'%')
            </if>
	</select>
	
	<select id="getBalanceOfPaymentSum" resultType="UserBalanceOfPaymentBean">
		select	(select IFNULL(sum(income),0) from app_user_income where type = 0) task_income, 

		(select IFNULL(sum(income),0) from app_user_income where type = 1) coupon_income, 

		(select IFNULL(sum(balance_num),0) from app_user_balance where type = 0 and `status` &lt; 3) withdraw_income, 

		(select IFNULL(sum(handling_charge),0) from app_user_balance where type = 0 and `status` &lt; 3) plat_fee, 

		(select IFNULL(sum(balance_num),0) from app_user_balance where type = 1 and `status` &lt; 3) recharge_income, 

		(select IFNULL(sum(balance),0) from app_user) balance,
		
		(select (task_income+coupon_income) = (withdraw_income+plat_fee+recharge_income+balance)) is_balance
		
	</select>
	
	
</mapper>