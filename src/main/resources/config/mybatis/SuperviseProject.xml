<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hmrz.mybatis.supervise.project">

    <select id="getProjectCount" parameterType="SuperviseProjectSearch" resultType="int">
		SELECT count(1) 
		FROM j_project jp
		left join j_vendor jv on jp.vendor_id = jv.vendor_id
		<where>
		    <if test="project_id !=null and project_id !='' ">
				jp.project_id = #{project_id} AND
			</if>
			<if test="vendor_name !=null and vendor_name !='' ">
				jv.name LIKE CONCAT("%",#{vendor_name},"%") AND
			</if>
			<if test="project_name !=null and project_name !='' ">
				jp.name LIKE CONCAT("%",#{project_name},"%") AND
			</if>
			<if test="create_btime != null and create_btime != ''">
                 jp.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00') AND
            </if>
            <if test="create_etime != null and create_etime != ''">
                jp.create_time &lt;= CONCAT(#{create_btime}, ' 23:59:59') AND
            </if>
            jp.is_del = 0  
		</where>
	</select>
	
   	<select id="getProjectList" parameterType="SuperviseProjectSearch" resultType="SuperviseProjectBean">
		select 
			jp.project_id,
			jp.name,
			jv.name as vendor_name,
			jp.vendor_id,
			jp.start_time,
			jp.end_time,
			jp.create_time,
			(select COUNT(DISTINCT space_id) from j_project_space jvs where jvs.project_id = jp.project_id) as space_nums,
			(select COUNT(DISTINCT space_id) from j_project_space jvs where jvs.project_id = jp.project_id AND jvs.status = 3) as executed_space_nums
		from j_project jp
		left join j_vendor jv on jp.vendor_id = jv.vendor_id
		<where>
		    <if test="project_id !=null and project_id !='' ">
				jp.project_id = #{project_id} AND
			</if>
			<if test="vendor_name !=null and vendor_name !='' ">
				jv.name LIKE CONCAT("%",#{vendor_name},"%") AND
			</if>
			<if test="project_name !=null and project_name !='' ">
				jp.name LIKE CONCAT("%",#{project_name},"%") AND
			</if>
			<if test="create_btime != null and create_btime != ''">
                jp.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00') AND
            </if>
            <if test="create_etime != null and create_etime != ''">
                jp.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59') AND
            </if>
            jp.is_del = 0  
		</where>
		ORDER BY jp.create_time desc 
		<if test="havePage == 1">
            LIMIT #{start},#{rows}
        </if>
	</select>
	
   	<select id="getProjectSpaceCount" parameterType="SuperviseSpaceSearch" resultType="int">
		SELECT count(1) FROM
   	    (SELECT
			T.space_id,
			T.project_id,
			T.vendor_id,
			jpe.project_space_id as task_id,
			TT.supervise_content,
			TTT.supervisor_type,
			CASE WHEN TTT.supervisor_type = 1 THEN (select jv.`name` from j_vendor jv where jv.vendor_id = TTT.supervisor) ELSE NULL END as vendor_name,
			CASE WHEN TTT.supervisor_type = 3 THEN TTT.price ELSE NULL END as price,
			TTT.token,
			(select moble from app_user au where au.user_id=jpe.execute_user) as operator,
			CASE WHEN TTT.status =3 THEN 3 WHEN TTT.status = 2 THEN 2  ELSE 0 END as status,
			ds.name,
			ds.position,
			(select xc.province_name from xt_city xc  where xc.city_code = ds.city_code and xc.city_level = 4) as province_name,
			(select xc.city_name from xt_city xc  where xc.city_code = ds.city_code and xc.city_level = 4) as city_name,
			ds.address,
			T.create_time,
			CASE WHEN jpe.status =1 THEN jpe.images ELSE null END as imgs,
			(select CONCAT(dmt1.name,"-",dmt.name) from db_media_type dmt  left join db_media_type dmt1 on dmt.father_id = dmt1.media_type_id
						where ds.type = dmt.media_type_id) as media_name,
			ds.province_code,
			ds.city_code,
			ds.district_code,
			ds.first_type,
			ds.type
			FROM(
				SELECT
					jps.space_id,
					jps.record_id,
					jps.project_id,
					jps.task_id,
					jp.vendor_id,
					jsr.supervisor,
					jps.create_time,
					jps.status
				FROM
					j_project_space jps
				LEFT JOIN
					j_project jp ON jps.project_id = jp.project_id
				LEFT JOIN
					j_supervisor_record jsr ON jps.project_id = jsr.project_id AND jps.record_id = jsr.record_id 
				WHERE jp.project_id = #{project_id} AND jp.vendor_id = jsr.supervisor
			) AS T
			LEFT JOIN
			(
				SELECT
					jps.space_id,
					jps.project_id,
					jsr.supervise_content
				FROM
					j_project_space jps
				LEFT JOIN
					j_project jp ON jps.project_id = jp.project_id
				LEFT JOIN
					j_supervisor_record jsr ON jps.project_id = jsr.project_id AND jps.record_id = jsr.record_id 
				WHERE jp.project_id = #{project_id} AND jp.vendor_id = jsr.promote_vendor
			) AS TT
			ON T.project_id = TT.project_id AND T.space_id = TT.space_id
			LEFT JOIN
			(
				SELECT 		
					RSD.record_id,
					RSD.space_id,
					jps.project_id,
					jps.task_id,
					jsr.supervisor,
					jsr.supervisor_type,
					jsr.token,
					jps.price,
					jps.status
				FROM j_project_space jps,j_supervisor_record jsr,
				(SELECT
					max(jsr.record_id) as record_id,
					jps.space_id,
					jps.project_id,
					jps.task_id,
					jsr.supervisor,
					jsr.supervisor_type,
					jsr.token,
					jps.price
				FROM
					j_project_space jps
				LEFT JOIN
					j_project jp ON jps.project_id = jp.project_id
				LEFT JOIN
					(select jsr1.*  from j_supervisor_record jsr1 WHERE jsr1.project_id = #{project_id}  ORDER BY jsr1.record_id desc) as jsr ON jps.project_id = jsr.project_id AND jps.record_id = jsr.record_id 
				WHERE jp.project_id = #{project_id} 
				GROUP BY jps.space_id) AS RSD
				WHERE jps.record_id = RSD.record_id AND jps.record_id = jsr.record_id AND jps.space_id = RSD.space_id 
			) AS TTT
			ON T.project_id = TTT.project_id AND T.space_id = TTT.space_id
			LEFT JOIN
				 (select jpe1.execute_user,
						jpe1.images,
						jpe1.project_space_id,
						jpe1.status,
						jpe1.execute_time,
						jpe1.space_id
				 FROM (select  jpe2.*,jps.space_id  FROM j_project_execute jpe2,j_project_space jps where jpe2.project_space_id = jps.task_id AND jps.project_id = #{project_id} ORDER BY  jpe2.status desc) as jpe1 
					GROUP BY jpe1.project_space_id) as jpe
			ON	TTT.space_id = jpe.space_id
			LEFT JOIN
				db_space ds
			ON T.space_id = ds.space_id
			) AS TTTT
			<where>
			<if test="name !=null and name !='' ">
				TTTT.name LIKE CONCAT("%",#{name},"%") AND
			</if>
			<if test="province_code !='' and province_code !=null and province_code !='-1' ">
		 		TTTT.province_code = #{province_code}  AND
		 	</if>
		 	<if test="city_code !='' and city_code !=null and city_code !='-1'">
		 		TTTT.city_code = #{city_code}  AND
		 	</if>
		 	<if test="district_code !='' and district_code !=null and district_code !='-1' ">
		 		TTTT.district_code = #{district_code}  AND
		 	</if>
		 	<if test="father_type !='' and father_type !=null and father_type !='-1' ">
		 		TTTT.first_type = #{father_type}  AND
		 	</if>
		 	<if test="type !='' and type !=null and type !='-1' ">
		 		TTTT.type = #{type}  AND
		 	</if>
		 	<if test="status !='' and status !=null">
		 		TTTT.status = #{status}  AND
		 	</if>
            1=1
		</where>
	</select>
	
   	<select id="getProjectSpaceList" parameterType="SuperviseSpaceSearch" resultType="SuperviseProjectSpaceBean">
   	    SELECT 
			TTTT.space_id,
			TTTT.project_id,
			TTTT.vendor_id,
			TTTT.task_id,
			TTTT.supervise_content,
			TTTT.supervisor_type,
			TTTT.vendor_name,
			TTTT.price,
			TTTT.token,
			TTTT.operator,
			TTTT.status,
			TTTT.name,
			TTTT.position,
			TTTT.province_name,
			TTTT.city_name,
			TTTT.address,
			TTTT.create_time,
			TTTT.imgs,
			TTTT.media_name
		FROM
   	    (SELECT
			T.space_id,
			T.project_id,
			T.vendor_id,
			jpe.project_space_id as task_id,
			TT.supervise_content,
			TTT.supervisor_type,
			CASE WHEN TTT.supervisor_type = 1 THEN (select jv.`name` from j_vendor jv where jv.vendor_id = TTT.supervisor) ELSE NULL END as vendor_name,
			CASE WHEN TTT.supervisor_type = 3 THEN TTT.price ELSE NULL END as price,
			TTT.token,
			(select moble from app_user au where au.user_id=jpe.execute_user) as operator,
			CASE WHEN TTT.status =3 THEN 3 WHEN TTT.status =2 THEN 2  ELSE 0 END as status,
			ds.name,
			ds.position,
			(select xc.province_name from xt_city xc  where xc.city_code = ds.city_code and xc.city_level = 4) as province_name,
			(select xc.city_name from xt_city xc  where xc.city_code = ds.city_code and xc.city_level = 4) as city_name,
			ds.address,
			T.create_time,
			CASE WHEN jpe.status =1 THEN jpe.images ELSE null END as imgs,
			(select CONCAT(dmt1.name,"-",dmt.name) from db_media_type dmt  left join db_media_type dmt1 on dmt.father_id = dmt1.media_type_id
						where ds.type = dmt.media_type_id) as media_name,
			ds.province_code,
			ds.city_code,
			ds.district_code,
			ds.first_type,
			ds.type
			FROM(
				SELECT
					jps.space_id,
					jps.record_id,
					jps.project_id,
					jps.task_id,
					jp.vendor_id,
					jsr.supervisor,
					jps.create_time,
					jps.status
				FROM
					j_project_space jps
				LEFT JOIN
					j_project jp ON jps.project_id = jp.project_id
				LEFT JOIN
					j_supervisor_record jsr ON jps.project_id = jsr.project_id AND jps.record_id = jsr.record_id 
				WHERE jp.project_id = #{project_id} AND jp.vendor_id = jsr.supervisor
			) AS T
			LEFT JOIN
			(
				SELECT
					jps.space_id,
					jps.project_id,
					jsr.supervise_content
				FROM
					j_project_space jps
				LEFT JOIN
					j_project jp ON jps.project_id = jp.project_id
				LEFT JOIN
					j_supervisor_record jsr ON jps.project_id = jsr.project_id AND jps.record_id = jsr.record_id 
				WHERE jp.project_id = #{project_id} AND jp.vendor_id = jsr.promote_vendor
			) AS TT
			ON T.project_id = TT.project_id AND T.space_id = TT.space_id
			LEFT JOIN
			(
				SELECT 		
					RSD.record_id,
					RSD.space_id,
					jps.project_id,
					jps.task_id,
					jsr.supervisor,
					jsr.supervisor_type,
					jsr.token,
					jps.price,
					jps.status
				FROM j_project_space jps,j_supervisor_record jsr,
				(SELECT
					max(jsr.record_id) as record_id,
					jps.space_id,
					jps.project_id,
					jps.task_id,
					jsr.supervisor,
					jsr.supervisor_type,
					jsr.token,
					jps.price
				FROM
					j_project_space jps
				LEFT JOIN
					j_project jp ON jps.project_id = jp.project_id
				LEFT JOIN
					(select jsr1.*  from j_supervisor_record jsr1 WHERE jsr1.project_id = #{project_id}  ORDER BY jsr1.record_id desc) as jsr ON jps.project_id = jsr.project_id AND jps.record_id = jsr.record_id 
				WHERE jp.project_id = #{project_id} 
				GROUP BY jps.space_id) AS RSD
				WHERE jps.record_id = RSD.record_id AND jps.record_id = jsr.record_id AND jps.space_id = RSD.space_id 
			) AS TTT
			ON T.project_id = TTT.project_id AND T.space_id = TTT.space_id
			LEFT JOIN
				 (select jpe1.execute_user,
						jpe1.images,
						jpe1.project_space_id,
						jpe1.status,
						jpe1.execute_time,
						jpe1.space_id
				 FROM (select  jpe2.*,jps.space_id  FROM j_project_execute jpe2,j_project_space jps where jpe2.project_space_id = jps.task_id AND jps.project_id = #{project_id} ORDER BY  jpe2.status desc) as jpe1 
					GROUP BY jpe1.project_space_id) as jpe
			ON	TTT.space_id = jpe.space_id
			LEFT JOIN
				db_space ds
			ON T.space_id = ds.space_id
			) AS TTTT
			<where>
			<if test="name !=null and name !='' ">
				TTTT.name LIKE CONCAT("%",#{name},"%") AND
			</if>
			<if test="province_code !='' and province_code !=null and province_code !='-1' ">
		 		TTTT.province_code = #{province_code}  AND
		 	</if>
		 	<if test="city_code !='' and city_code !=null and city_code !='-1'">
		 		TTTT.city_code = #{city_code}  AND
		 	</if>
		 	<if test="district_code !='' and district_code !=null and district_code !='-1' ">
		 		TTTT.district_code = #{district_code}  AND
		 	</if>
		 	<if test="father_type !='' and father_type !=null and father_type !='-1' ">
		 		TTTT.first_type = #{father_type}  AND
		 	</if>
		 	<if test="type !='' and type !=null and type !='-1' ">
		 		TTTT.type = #{type}  AND
		 	</if>
		 	<if test="status !='' and status !=null">
		 		TTTT.status = #{status}  AND
		 	</if>
            1=1
		</where>
			ORDER BY TTTT.create_time desc 
		<if test="havePage == 1">
            LIMIT #{start},#{rows}
        </if>   	    
	</select>
	
   	<select id="getRecordBySpaceId" parameterType="java.util.Map" resultType="String">
		SELECT 
			 CASE 
			 	WHEN jsr.supervisor_type = 0 THEN (select concat('创建企业：',jv.`name`) from j_vendor jv where jv.vendor_id = jsr.supervisor) 
			 	WHEN jsr.supervisor_type = 1 THEN (select concat('企业：',jv.`name`) from j_vendor jv where jv.vendor_id = jsr.supervisor) 
			 	WHEN jsr.supervisor_type = 2 THEN '闲侠'
			 	WHEN jsr.supervisor_type = 3 THEN  concat('个人：执行口令',jsr.token)
			 	ELSE NULL 
			 	END as vendor_name
		FROM
			j_supervisor_record jsr,j_project_space jps
		WHERE
			jsr.record_id  = jps.record_id AND jsr.project_id = jps.project_id
			AND jps.space_id =#{space_id} AND jps.project_id = #{project_id}
		ORDER BY jps.record_id
	</select>
	
  	<select id="getAuditCount" parameterType="SuperviseProjectSearch" resultType="int">
  	    select count(1)
		from j_project jp ,j_supervisor_record jsr,j_vendor jvv
		where jsr.project_id = jp.project_id AND jp.vendor_id = jvv.vendor_id
		AND jsr.supervisor_type = 2
		<if test="project_name !=null and project_name !='' ">
			AND jp.name LIKE CONCAT("%",#{project_name},"%") 
		</if>
		<if test="vendor_name !='' and vendor_name !=null">
	 		AND jvv.name LIKE CONCAT("%",#{vendor_name},"%") 
	 	</if>
	 	<if test="create_btime != null and create_btime != ''">
            AND jsr.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00') 
        </if>
        <if test="create_etime != null and create_etime != ''">
            AND jsr.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
        </if>
        <if test="status !='' and status !=null">
	 		AND jsr.status = #{status} 
	 	</if>
	</select>
  	
	<select id="getAuditList" parameterType="SuperviseProjectSearch" resultType="SuperviseProjectBean">
	    select jp.project_id,jp.`name`,jvv.`name` as vendor_name,
		(select jv.`name` from j_supervisor_record jsr1,j_vendor jv where jsr1.promote_vendor = jv.vendor_id AND jsr1.supervisor_type = 2 AND jsr1.record_id = jsr.record_id ORDER BY record_id LIMIT 0,1) as assign_vendor_name,
		(select jsr1.create_time from j_supervisor_record jsr1 where jsr1.supervisor_type = 2 AND jsr1.record_id = jsr.record_id  ORDER BY record_id LIMIT 0,1) as create_time,
		(select jsr1.status from j_supervisor_record jsr1 where jsr1.supervisor_type = 2 AND jsr1.record_id = jsr.record_id ORDER BY record_id LIMIT 0,1) as status,
		(select jsr1.record_id from j_supervisor_record jsr1 where jsr1.supervisor_type = 2 AND jsr1.record_id = jsr.record_id ORDER BY record_id LIMIT 0,1) as record_id
		from j_project jp ,j_supervisor_record jsr,j_vendor jvv
		where jsr.project_id = jp.project_id AND jp.vendor_id = jvv.vendor_id
		AND jsr.supervisor_type = 2
		<if test="project_name !=null and project_name !='' ">
			AND jp.name LIKE CONCAT("%",#{project_name},"%") 
		</if>
		<if test="vendor_name !='' and vendor_name !=null">
	 		AND jvv.name LIKE CONCAT("%",#{vendor_name},"%") 
	 	</if>
	 	<if test="create_btime != null and create_btime != ''">
            AND jsr.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00') 
        </if>
        <if test="create_etime != null and create_etime != ''">
            AND jsr.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
        </if>
       	<if test="status !='' and status !=null">
	 		AND jsr.status = #{status} 
	 	</if>
        ORDER BY jsr.record_id desc
		<if test="havePage == 1">
            LIMIT #{start},#{rows}
        </if>   
	</select>
	
	<select id="auditInfo" parameterType="String" resultType="SuperviseProjectBean">
	    select jp.project_id,jp.`name`,jvv.`name` as vendor_name,
		(select jv.`name` from j_supervisor_record jsr1,j_vendor jv where jsr1.promote_vendor = jv.vendor_id AND jsr1.supervisor_type = 2 AND jsr1.record_id = jsr.record_id ORDER BY record_id LIMIT 0,1) as assign_vendor_name,
		jsr.promote_vendor as vendor_id,
		(select jsr1.create_time from j_supervisor_record jsr1 where jsr1.supervisor_type = 2 AND jsr1.record_id = jsr.record_id  ORDER BY record_id LIMIT 0,1) as create_time,
		(select jsr1.status from j_supervisor_record jsr1 where jsr1.supervisor_type = 2 AND jsr1.record_id = jsr.record_id ORDER BY record_id LIMIT 0,1) as status,
		(select jsr1.record_id from j_supervisor_record jsr1 where jsr1.supervisor_type = 2 AND jsr1.record_id = jsr.record_id ORDER BY record_id LIMIT 0,1) as record_id,
		jsr.price,
		jsr.descript,
		jp.start_time,
		jp.end_time
		from j_project jp ,j_supervisor_record jsr,j_vendor jvv
		where 
		jsr.record_id = #{record_id} AND
		jsr.project_id = jp.project_id AND jp.vendor_id = jvv.vendor_id	
	</select>
	
	<select id="recordSpaceCount" parameterType="SuperviseProjectSearch" resultType="int">
  	    select count(1)
  	    FROM
  	    j_project_space jps  where jps.record_id = #{record_id}
  	    <if test="havePrice == 1">
            AND jps.price is null
        </if>   
	</select>
  	
	<select id="recordSpaceList" parameterType="SuperviseProjectSearch" resultType="SuperviseProjectSpaceBean">
	   SELECT
	   		jps.task_id,
			ds. NAME,
			ds.position,
			(
				SELECT
					xc.province_name
				FROM
					xt_city xc
				WHERE
					xc.city_code = ds.city_code
				AND xc.city_level = 4
			) AS province_name,
			(
				SELECT
					xc.city_name
				FROM
					xt_city xc
				WHERE
					xc.city_code = ds.city_code
				AND xc.city_level = 4
			) AS city_name,
			ds.address,
			(
				SELECT
					CONCAT(dmt1. NAME, "-", dmt. NAME)
				FROM
					db_media_type dmt
				LEFT JOIN db_media_type dmt1 ON dmt.father_id = dmt1.media_type_id
				WHERE
					ds.type = dmt.media_type_id
			) AS media_name,
			ds.position,
			jsr.supervise_content,
			jps.price
		FROM
			j_project_space jps,
			db_space ds,
			j_supervisor_record jsr
		WHERE
			jps.space_id = ds.space_id
		AND jps.record_id = jsr.record_id
		AND jps.record_id = #{record_id}
        ORDER BY jps.task_id desc
		<if test="havePage == 1">
            LIMIT #{start},#{rows}
        </if>   
	</select>
	
	<update id="auditSpacePrice" parameterType="SuperviseProjectSpaceBean">
        UPDATE j_project_space SET price = #{price} WHERE task_id = #{task_id}
    </update>
	
	<update id="acceptance" parameterType="SuperviseProjectBean">
	    UPDATE j_project_space jps,j_supervisor_record jsr
	    SET jsr.price = #{price} ,jsr.descript = #{descript} ,jps.status = 1,jsr.status = 1
		WHERE jps.record_id = jsr.record_id AND jsr.record_id = #{record_id}
    </update>
	
    <select id="getAuditResultCount" parameterType="SuperviseProjectSearch" resultType="int">
		SELECT 
			count(1)
		FROM 
			j_supervisor_record jsr 
		LEFT JOIN
			j_project_space jps
		ON jsr.record_id = jps.record_id
		LEFT JOIN
			db_space ds
		ON jps.space_id = ds.space_id 
		LEFT JOIN
			j_project jp
		ON jps.project_id = jp.project_id 
		LEFT JOIN
			j_vendor jv
		ON jp.vendor_id = jv.vendor_id
		WHERE 
		jsr.supervisor_type = 2
		AND jsr.status = 1
		<if test="space_name !=null and space_name !='' ">
			AND ds.name LIKE CONCAT("%",#{space_name},"%") 
		</if>
		<if test="project_name !=null and project_name !='' ">
			AND jp.name LIKE CONCAT("%",#{project_name},"%") 
		</if>
		<if test="vendor_name !='' and vendor_name !=null">
	 		AND jv.name LIKE CONCAT("%",#{vendor_name},"%") 
	 	</if>
       	<if test="status !='' and status !=null">
	 		AND jps.status = #{status} 
	 	</if>
	</select>
	
    <select id="getAuditResultList" parameterType="SuperviseProjectSearch" resultType="SuperviseProjectSpaceBean" >
		SELECT 
			jps.space_id,
			ds.name as name,
			jp.`name` as project_name,
			(select jv.`name` from j_supervisor_record jsr1,j_vendor jv where jsr1.supervisor = jv.vendor_id AND jsr1.supervisor_type = 0 AND jsr1.project_id = jp.project_id ORDER BY record_id LIMIT 0,1) as vendor_name,
			(select jv.`name` from j_supervisor_record jsr1,j_vendor jv where jsr1.promote_vendor = jv.vendor_id AND jsr1.supervisor_type = 2 AND jsr1.record_id = jsr.record_id ORDER BY record_id LIMIT 0,1) as assign_vendor_name,
			(select jsr1.create_time from j_supervisor_record jsr1 where jsr1.supervisor_type = 2 AND jsr1.record_id = jsr.record_id ORDER BY record_id LIMIT 0,1) as create_time,
			jps.`status`,
			jps.task_id,
			jps.record_id
		FROM 
			j_supervisor_record jsr 
		LEFT JOIN
			j_project_space jps
		ON jsr.record_id = jps.record_id
		LEFT JOIN
			db_space ds
		ON jps.space_id = ds.space_id 
		LEFT JOIN
			j_project jp
		ON jps.project_id = jp.project_id 
		LEFT JOIN
			j_vendor jv
		ON jp.vendor_id = jv.vendor_id
		WHERE 
		jsr.supervisor_type = 2
		AND jsr.status = 1
		<if test="space_name !=null and space_name !='' ">
			AND ds.name LIKE CONCAT("%",#{space_name},"%") 
		</if>
		<if test="project_name !=null and project_name !='' ">
			AND jp.name LIKE CONCAT("%",#{project_name},"%") 
		</if>
		<if test="vendor_name !='' and vendor_name !=null">
	 		AND jv.name LIKE CONCAT("%",#{vendor_name},"%") 
	 	</if>
       	<if test="status !='' and status !=null">
	 		AND jps.status = #{status} 
	 	</if>
		ORDER BY jps.task_id desc
		<if test="havePage == 1">
            LIMIT #{start},#{rows}
        </if>   
	</select>
	
    
    <select id="auditResultExecuteCount" parameterType="SuperviseProjectExecuteSearch" resultType="int">
		SELECT 
			count(1)
		FROM 
			j_project_execute jpe
		LEFT JOIN
			app_user au
		ON  jpe.execute_user = au.user_id
		WHERE 
		jpe.project_space_id = #{task_id}
		<if test="execute_id !='' and execute_id !=null">
	 		AND jpe.execute_id = #{execute_id} 
	 	</if>
		<if test="executor !='' and executor !=null">
	 		AND au.moble = #{executor} 
	 	</if>
       	<if test="status !='' and status !=null">
	 		AND jpe.status = #{status} 
	 	</if>
	</select>
	
    <select id="auditResultExecuteList" parameterType="SuperviseProjectExecuteSearch" resultType="SuperviseProjectSpaceExecuteBean" >
		SELECT 
			jpe.execute_id,
			au.moble as executor,
			jpe.execute_time,
			jpe.status
		FROM 
			j_project_execute jpe
		LEFT JOIN
			app_user au
		ON  jpe.execute_user = au.user_id
		WHERE 
		jpe.project_space_id = #{task_id}
		<if test="execute_id !='' and execute_id !=null">
	 		AND jpe.execute_id = #{execute_id} 
	 	</if>
		<if test="executor !='' and executor !=null">
	 		AND au.moble = #{executor} 
	 	</if>
       	<if test="status !='' and status !=null">
	 		AND jps.status = #{status} 
	 	</if>
		ORDER BY jpe.execute_id
		<if test="havePage == 1">
            LIMIT #{start},#{rows}
        </if>   
	</select>
	
    <select id="auditResultExecuteInfo" parameterType="String" resultType="SuperviseProjectSpaceExecuteBean">
		select 
			    ds.name,
			    (select CONCAT(dmt1.name,"-",dmt.name) from db_media_type dmt  left join db_media_type dmt1 on dmt.father_id = dmt1.media_type_id
								where ds.type = dmt.media_type_id) as media_name,
				ds.address,
				jsr.supervise_content,
				jp.start_time,
				jp.end_time,
				au.user_id,
				au.moble as executor,
				jps.price,
				jsr.descript,
				jpe.images as imgs,
				jpe.status,
				jpe.project_space_id as task_id
		FROM
				j_project_execute jpe,j_project_space jps,j_supervisor_record jsr,j_project jp,db_space ds,app_user au 
		WHERE 
				jpe.project_space_id = jps.task_id 
		AND jps.project_id = jp.project_id
		AND jps.record_id = jsr.record_id
		AND jps.space_id = ds.space_id
		AND jpe.execute_user = au.user_id
		AND jpe.execute_id = #{execute_id}
	</select>
	
    <update id="passTask" parameterType="java.util.Map">
        UPDATE j_project_execute jpe,j_project_space jps,app_user au
	    SET jps.status = 3,jpe.status = 1,jpe.audit_time = NOW(),jpe.auditor = #{auditor},au.balance = au.balance + jps.price
		WHERE jpe.project_space_id = jps.task_id AND jpe.execute_user = au.user_id AND jpe.execute_id = #{execute_id}
	</update>
	
    <update id="passRejectTask" parameterType="java.util.Map">
		UPDATE j_project_execute jpe
	    SET jpe.status = 2,jpe.audit_time = NOW(),jpe.auditor = #{auditor}
		WHERE jpe.project_space_id = #{task_id} AND jpe.status = 0
	</update>
	
	<update id="rejectTask" parameterType="java.util.Map">
		UPDATE j_project_execute jpe
	    SET jpe.status = 2,jpe.audit_time = NOW(),jpe.auditor = #{auditor}
		WHERE jpe.execute_id = #{execute_id}
	</update>
    
</mapper>