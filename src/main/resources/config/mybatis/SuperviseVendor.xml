<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hmrz.mybatis.supervise.vendor">

    <insert id="addSuperviseVendor" parameterType="SuperviseVendorBean" useGeneratedKeys="true" keyProperty="vendor_id">
		insert into j_vendor (name,contact,phone,email,
			<if test="province_code !=null and province_code !='' and province_code !='-1'">
				province_code,
			</if>
			<if test="city_code !=null and city_code !='' and city_code !='-1'">
				city_code,
			</if>
			address,create_user,remark) 
		values (#{name},#{contact},#{phone},#{email},
			<if test="province_code !=null and province_code !='' and province_code !='-1'">
				#{province_code},
			</if>
			<if test="city_code !=null and city_code !='' and city_code !='-1'">
				#{city_code},
			</if>
			#{address},#{create_user},#{remark})
	</insert>
	
   	<insert id="addSuperviseUser" parameterType="SuperviseUserBean">
		insert into j_user (moble,password,password_salt,vendor_id,remark) 
		values (#{moble},#{password},#{password_salt},#{vendor_id},#{remark})
	</insert>
	
   	
   	<update id="updateSuperviseVendor" parameterType="SuperviseVendorBean">
		update j_vendor 
		set name = #{name}, contact = #{contact} , phone = #{phone},email = #{email},
		<if test="province_code !=null and province_code !='' and province_code !='-1'">
			province_code = #{province_code},
		</if>
		<if test="city_code !=null and city_code !='' and city_code !='-1'">
			city_code = #{city_code},
		</if>
		address = #{address},create_user=#{create_user},remark=#{remark} where vendor_id = #{vendor_id}
	</update>
	
   	<update id="updateSuperviseUser" parameterType="SuperviseUserBean">
		update j_user set moble = #{moble} , 
		<if test="password !=null and password !='' ">
			password = #{password},password_salt = #{password_salt}
		</if>
		where vendor_id = #{vendor_id}
	</update>
	
   	<select id="getVendorById" parameterType="String" resultType="SuperviseVendorBean">
		select 
			jv.vendor_id,
			jv.name,
			ju.moble,
			jv.contact,
			jv.phone,
			jv.email,
			jv.province_code,
	 		jv.city_code,
			jv.address,
			jv.remark,
			jv.create_time
		from j_vendor jv left join j_user ju on jv.vendor_id = ju.vendor_id
		where jv.vendor_id = #{vendor_id}	
	</select>
	
	<select id="getSuperviseVendorList" parameterType="SuperviseVendorSearch" resultType="SuperviseVendorBean">
		select 
			jv.vendor_id,
			jv.name,
			ju.moble,
			jv.contact,
			(select IFNULL(sum(jac.amount),0) from j_account_charge jac where jac.vendor_id = jv.vendor_id and jac.status = 1) as charge,
			(select IFNULL(sum(jac1.amount),0) from j_account_consume jac1 where jac1.vendor_id = jv.vendor_id) as consume,
			(select IFNULL(sum(jaw.amount),0) from j_account_withdraw jaw where jaw.vendor_id = jv.vendor_id and jaw.status = 1) as withdraw,
			(select IFNULL(sum(jaw.handling_fee),0) from j_account_withdraw jaw where jaw.vendor_id = jv.vendor_id and jaw.status = 1) as handling_fee,
			jv.balance
		from j_vendor jv
		left join j_user ju on jv.vendor_id = ju.vendor_id
		<where>
			<if test="moble !=null and moble !='' ">
				ju.moble = #{moble} AND
			</if>
			<if test="name !=null and name !='' ">
				jv.name LIKE CONCAT("%",#{name},"%") AND
			</if>
            jv.is_del = 0 AND ju.is_del = 0
		</where>
		ORDER BY jv.create_time desc 
		<if test="havePage == 1">
            LIMIT #{start},#{rows}
        </if>
	</select>
	
	<select id="getSuperviseVendorCount" parameterType="SuperviseVendorSearch" resultType="int">
		select count(1) from j_vendor jv
		left join j_user ju on jv.vendor_id = ju.vendor_id
		<where>
			<if test="moble !=null and moble !='' ">
				ju.moble = #{moble} AND
			</if>
			<if test="name !=null and name !='' ">
				jv.name LIKE CONCAT("%",#{name},"%") AND
			</if>
            jv.is_del = 0 AND ju.is_del = 0
		</where>
	</select>
	
	<!-- 充值申请  操作状态 =======================================================================================  -->
  	<update id="charge" parameterType="java.util.Map">
  	    UPDATE j_account_charge jac ,j_vendor jv
        SET jac.status = #{status},jac.update_time = NOW()
        <if test="auditor != null and auditor !='' ">
        ,jac.update_user = #{auditor}
        </if>
        <if test="status == 1 ">
        ,jv.balance = jv.balance + jac.amount
        </if>
		WHERE jac.vendor_id = jv.vendor_id AND jac.status = 0 AND jac.charge_id in
		<foreach collection="id" item="item"  separator="," open="(" close=")">
		(#{item,jdbcType=VARCHAR})
        </foreach>
	</update>
	
  	
  	<!-- 处理充值申请 ==============================================================================================  -->
  	<select id="getChargeCount" parameterType="SuperviseVendorChargeSearch" resultType="int">
        SELECT
        	count(1)
        FROM 
        	j_account_charge jac ,j_user ju,j_vendor jv
        WHERE
            jac.create_user = ju.user_id AND jac.vendor_id = jv.vendor_id
            <if test="vendor_id != null and vendor_id != ''">
				AND jac.vendor_id = #{vendor_id}
			</if>
			<if test="pay_no != null and pay_no != ''">
				AND jac.pay_no = #{pay_no}
			</if>
			<if test="source != null and source != ''">
				AND jac.source = #{source}
			</if>
			<if test="status != null and status != ''">
				AND jac.status = #{status}
			</if>
            <if test="moble != null and moble != ''">
                AND ju.moble = #{moble}
            </if>
            <if test="apply_btime != null and apply_btime != ''">
                AND jac.create_time &gt;= CONCAT(#{apply_btime}, ' 00:00:00')
            </if>
            <if test="apply_etime != null and apply_etime != ''">
                AND jac.create_time &lt;= CONCAT(#{apply_etime}, ' 23:59:59')
            </if>
            <if test="audit_btime != null and audit_btime != ''">
                AND jac.create_time &gt;= CONCAT(#{audit_btime}, ' 00:00:00')
            </if>
            <if test="audit_etime != null and audit_etime != ''">
                AND jac.create_time &lt;= CONCAT(#{audit_etime}, ' 23:59:59')
            </if>
	</select>
  	
	<select id="getChargeList" parameterType="SuperviseVendorChargeSearch" resultType="SuperviseVendorChargeBean">
        SELECT
        	jac.charge_id,
        	jac.amount,
        	jv.name as vendor_name,    	
        	jac.create_time,
        	jac.source,
        	jac.pay_no,
        	jac.status,
        	jac.remark,
			ju.moble as create_user,
			(select xm.manager_name from xt_manager xm where xm.manager_id = jac.update_user) as update_user,
			jac.update_time
        FROM 
        	j_account_charge jac ,j_user ju,j_vendor jv
        WHERE
            jac.create_user = ju.user_id AND jac.vendor_id = jv.vendor_id
			<if test="vendor_id != null and vendor_id != ''">
				AND jac.vendor_id = #{vendor_id}
			</if>
			<if test="pay_no != null and pay_no != ''">
				AND jac.pay_no = #{pay_no}
			</if>
			<if test="source != null and source != ''">
				AND jac.source = #{source}
			</if>
			<if test="status != null and status != ''">
				AND jac.status = #{status}
			</if>
            <if test="moble != null and moble != ''">
                AND ju.moble = #{moble}
            </if>
            <if test="apply_btime != null and apply_btime != ''">
                AND jac.create_time &gt;= CONCAT(#{apply_btime}, ' 00:00:00')
            </if>
            <if test="apply_etime != null and apply_etime != ''">
                AND jac.create_time &lt;= CONCAT(#{apply_etime}, ' 23:59:59')
            </if>
            <if test="audit_btime != null and audit_btime != ''">
                AND jac.create_time &gt;= CONCAT(#{audit_btime}, ' 00:00:00')
            </if>
            <if test="audit_etime != null and audit_etime != ''">
                AND jac.create_time &lt;= CONCAT(#{audit_etime}, ' 23:59:59')
            </if>
            ORDER BY 
           		jac.create_time DESC
	        <if test="havePage == 1">
	        	LIMIT #{start} , #{rows}
	        </if>
	</select>
	
	<!-- 更新监播客户充值申请备注 ============================================================== -->
	<update id="updateChargeRemark" parameterType="SuperviseVendorChargeBean">
		update j_account_charge set remark = #{remark} where charge_id = #{charge_id}
	</update>
	
	<!-- 插入监播客户充值信息     ============================================================= -->
	<insert id="addCharge" parameterType="SuperviseVendorChargeBean">
		insert into j_account_charge (
			vendor_id,
			amount,
			remark,
			status,   <!-- 直接插入1：成功 -->
			create_user,
			update_user,
			update_time,
			source
			) 
		values (#{vendor_id},#{amount},#{remark},1,
			(select user_id from j_user where vendor_id = #{vendor_id} limit 0,1)
			,#{update_user},NOW(),#{source})
	</insert>
    
    <select id="getReportConsumeList" parameterType="VendorSearch" resultType="VendorConsumeBean" >
		select cvc.execute_id,cvc.task_name,IFNULL(cvc.task_consume+cvc.plat_consume,0) task_consume,cvc.create_time ,au.moble
		from c_vendor_consume cvc
		left join report_plan_execute rpe on cvc.execute_id = rpe.execute_id
		left join app_user au on rpe.executor =  au.user_id
		<where>
			cvc.vendor_id = #{vendor_id} and cvc.task_type = 7 AND cvc.task_consume > 0
			<if test=" execute_id !=null and execute_id !='' ">
				AND cvc.execute_id = #{execute_id} 
			</if>
			<if test=" task_name !=null and task_name !='' ">
				AND cvc.task_name like concat("%",#{task_name},"%") 
			</if>
			<if test="create_btime != null and create_btime != ''">
            	AND cvc.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
	       	</if>
	        <if test="create_etime != null and create_etime != ''">
	            AND cvc.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
	        </if>
		</where>
		ORDER BY cvc.create_time DESC
		<if test="havePage == 1">
     		LIMIT #{start} , #{rows}
       	</if>
	</select>
	
	
	<select id="getReportConsumeCount" parameterType="SuperviseVendorSearch" resultType="int">
		select count(1)
		from c_vendor_consume cvc
		<where>
			cvc.vendor_id = #{vendor_id} and cvc.task_type = 7 AND cvc.task_consume > 0
			<if test=" execute_id !=null and execute_id !='' ">
				AND cvc.execute_id = #{execute_id} 
			</if>
			<if test=" task_name !=null and task_name !='' ">
				AND cvc.task_name like concat("%",#{task_name},"%") 
			</if>
			<if test="create_btime != null and create_btime != ''">
            	AND cvc.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
	       	</if>
	        <if test="create_etime != null and create_etime != ''">
	            AND cvc.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
	        </if>
		</where>
	</select>
	
	<!-- 结算申请  ======================================================================================= -->
	<select id="getWithDrawList" parameterType="SuperviseVendorWithDrawSearch" resultType="SuperviseVendorWithDrawBean">
        SELECT
        	jaw.withdraw_id,
        	jaw.withdraw_user,
        	ju.moble as withdraw_user_moble,
        	jaw.vendor_id,
        	jaw.alipay_account,
        	jaw.alipay_name,
        	jaw.amount,
        	jaw.handling_fee,
        	jaw.withdraw_time,
        	jaw.contact,
        	jaw.phone,
        	jaw.remark,
        	(select xm.manager_name from xt_manager xm where xm.manager_id = jaw.auditor ) as auditor,
        	jaw.audit_time,
        	jaw.status
        FROM 
        	j_account_withdraw jaw ,j_user ju
        WHERE
            jaw.withdraw_user = ju.user_id
           	 <if test="status != null and status != ''">
           		AND jaw.status = #{status}
           	 </if>
           	 <if test="status == null or status == '' ">
           		AND jaw.status > 0
           	 </if>
            <if test="apply_btime != null and apply_btime != ''">
                AND jaw.withdraw_time &gt;= CONCAT(#{apply_btime}, ' 00:00:00')
            </if>
            <if test="apply_etime != null and apply_etime != ''">
                AND jaw.withdraw_time &lt;= CONCAT(#{apply_etime}, ' 23:59:59')
            </if>
            <if test="audit_btime != null and audit_btime != ''">
                AND jaw.audit_time &gt;= CONCAT(#{audit_btime}, ' 00:00:00')
            </if>
            <if test="audit_etime != null and audit_etime != ''">
                AND jaw.audit_time &lt;= CONCAT(#{audit_etime}, ' 23:59:59')
            </if>
            <if test="moble != null and moble != ''">
                AND ju.moble = #{moble}
            </if>
            ORDER BY 
            <choose>
            	<when test="status == 0">
            		jaw.withdraw_time
            	</when>
            	<otherwise>
            		jaw.withdraw_time DESC
            	</otherwise>
            </choose>
	        <if test="havePage == 1">
	        	LIMIT #{start} , #{rows}
	        </if>
	</select>
	
	<select id="getWithDrawCount" parameterType="SuperviseVendorWithDrawSearch" resultType="int">
        SELECT
        	count(1)
        FROM 
        	j_account_withdraw jaw ,j_user ju
        WHERE
            jaw.withdraw_user = ju.user_id
           	 <if test="status != null and status != ''">
           		AND jaw.status = #{status}
           	 </if>
           	 <if test="status == null or status == '' ">
           		AND jaw.status > 0
           	 </if>
            <if test="apply_btime != null and apply_btime != ''">
                AND jaw.withdraw_time &gt;= CONCAT(#{apply_btime}, ' 00:00:00')
            </if>
            <if test="apply_etime != null and apply_etime != ''">
                AND jaw.withdraw_time &lt;= CONCAT(#{apply_etime}, ' 23:59:59')
            </if>
            <if test="audit_btime != null and audit_btime != ''">
                AND jaw.audit_time &gt;= CONCAT(#{audit_btime}, ' 00:00:00')
            </if>
            <if test="audit_etime != null and audit_etime != ''">
                AND jaw.audit_time &lt;= CONCAT(#{audit_etime}, ' 23:59:59')
            </if>
            <if test="moble != null and moble != ''">
                AND ju.moble = #{moble}
            </if>
	</select>
	
	<!-- 处理提现申请  操作状态 -->
  	<update id="withdraw" parameterType="java.util.Map">
  	    UPDATE j_account_withdraw jaw ,j_user ju,j_vendor jv
        SET jaw.status = #{status},audit_time = NOW()
        <if test="auditor != null and auditor !='' ">
        ,jaw.auditor = #{auditor}
        </if>
        <if test="status == 2 ">
        ,jv.balance = jv.balance + jaw.amount + jaw.handling_fee
        </if>
		WHERE jaw.withdraw_user = ju.user_id AND ju.vendor_id = jv.vendor_id AND jaw.vendor_id = ju.vendor_id AND jaw.withdraw_id in
		<foreach collection="id" item="item"  separator="," open="(" close=")">
		(#{item,jdbcType=VARCHAR})
        </foreach>
	</update>
	
  	<!-- 处理客户账户余额情况  -->
  	<update id="updateVendorBalance" parameterType="java.util.Map">
  	    UPDATE j_vendor jv
        SET  jv.balance = jv.balance + #{amount}*#{type}
		WHERE jv.vendor_id = #{vendor_id}
		<if test="type == '-1' ">
        AND jv.balance >= #{amount}
        </if>
	</update>
	
  	<!-- 监播客户点位管理 -->
  	<select id="countSuperviseVendorSpaces" parameterType="SuperviseVendorSpaceSearch" resultType="int">
        SELECT
		  COUNT(*)
		FROM j_vendor_space jvs,
		     db_space ds
		WHERE jvs.vendor_id = #{vendor_id}
		AND jvs.space_id = ds.space_id
		AND jvs.is_del = 0
		<if test="province_id != null and province_id !='' and province_id !='-1'">
          AND ds.province_code = #{province_id}
        </if>
        <if test="city_id != null and city_id !='' and city_id !='-1' ">
          AND ds.city_code = #{city_id}
        </if>
        <if test="name != null and name !='' ">
          AND ds.name LIKE CONCAT('%', #{name}, '%')
        </if>
    </select>
    
    <select id="listSuperviseVendorSpaces" parameterType="SuperviseVendorSpaceSearch" resultType="SuperviseVendorSpacesBean">
	    SELECT
		  jvs.vendor_space_id,
		  xc.province_name AS province,
		  xc.city_name AS city,
		  ds.name,
		  ds.address,
		  (SELECT
		      dmt.name
		    FROM db_media_type dmt
		    WHERE dmt.media_type_id = ds.first_type) AS first_type,
		  (SELECT
		      dmt.name
		    FROM db_media_type dmt
		    WHERE dmt.media_type_id = ds.type) AS second_type,
		  (select CONCAT(dmt1.name,"-",dmt.name) from db_media_type dmt  left join db_media_type dmt1 on dmt.father_id = dmt1.media_type_id
				where ds.type = dmt.media_type_id) as media_type,
		  ds.position,
		  jvs.vendor_id,
		  jvs.space_id,
		  jvs.rename,
		  jvs.create_user,
		  ds.position
		  
		FROM j_vendor_space jvs,
		     db_space ds,
		     xt_city xc
		WHERE jvs.vendor_id = #{vendor_id}
		AND jvs.space_id = ds.space_id
		AND jvs.is_del = 0
		AND xc.province_code = ds.province_code
		AND xc.city_code = ds.city_code
		AND xc.city_level = 4
		<if test="province_id != null and province_id !='' and province_id !='-1'">
          AND ds.province_code = #{province_id}
        </if>
        <if test="city_id != null and city_id !='' and city_id !='-1' ">
          AND ds.city_code = #{city_id}
        </if>
        <if test="name != null and name !='' ">
          AND ds.name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="havePage == 1">
            limit #{start},#{rows}
        </if>
    </select>
    
    <insert id="addSuperviseVendorSpaces" parameterType="SuperviseVendorSpacesBean">
        INSERT INTO j_vendor_space(
			vendor_id,
			space_id,
			create_user
			)
        VALUE(#{vendor_id}, #{space_id}, #{create_user})
    </insert>
    
    <update id="delSuperviseVendorSpaces" parameterType="SuperviseVendorSpacesBean">
        UPDATE j_vendor_space SET is_del = 1, update_user= #{update_user} WHERE vendor_space_id= #{vendor_space_id}
    </update>
  	
     <update id="renameSuperviseVendorSpace" parameterType="SuperviseVendorSpacesBean">
        UPDATE j_vendor_space SET `rename` = #{rename} WHERE vendor_space_id = #{vendor_space_id}
    </update>
    
    <select id="surplusSpaceCount" parameterType="SuperviseSpaceSearch" resultType="int">
		select  count(1)  
		FROM
		(select ds.space_id,jvs.vendor_id,jvs.is_del
		from db_space ds left join
		j_vendor_space jvs
		on jvs.space_id = ds.space_id and jvs.vendor_id = #{vendor_id} AND jvs.is_del = 0
		<where>
		 	<if test="name !='' and name !=null">
		 		ds.name LIKE CONCAT("%",#{name},"%") AND
		 	</if>
		 	<if test="province_code !='' and province_code !=null and province_code !='-1' ">
		 		ds.province_code = #{province_code}  AND
		 	</if>
		 	<if test="city_code !='' and city_code !=null and city_code !='-1'">
		 		ds.city_code = #{city_code}  AND
		 	</if>
		 	<if test="district_code !='' and district_code !=null and district_code !='-1' ">
		 		ds.district_code = #{district_code}  AND
		 	</if>
		 	<if test="type !='' and type !=null and type !='-1' ">
		 		ds.type = #{type}  AND
		 	</if>
		 	<if test="father_type !='' and father_type !=null and father_type !='-1' ">
		 		ds.first_type = #{father_type}  AND
		 	</if>
		 	<if test="address !='' and address !=null">
		 		ds.address LIKE CONCAT("%",#{address},"%") AND
		 	</if>
		 	<if test="create_btime != null and create_btime != ''">
                ds.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00') AND
            </if>
            <if test="create_etime != null and create_etime != ''">
                ds.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59') AND
            </if>
            1=1
         </where>
		) as T
		WHERE T.vendor_id IS NULL AND T.is_del IS NULL
		
	</select>
     
     <select id="surplusSpaceList" parameterType="SuperviseSpaceSearch" resultType="DBSpaceBean">
		SELECT  T.space_id,
			    T.name,
				T.city_name,
				T.district_name,
				T.media_name,
				T.number,
				T.is_illumine,
				T.relegation,
				T.moble,
				T.address,
				T.show_type,
				T.position,
				T.create_time,
				T.imgs
		FROM(
         select ds.space_id,ds.name,
			 (select xc.city_name from xt_city xc  where xc.city_code = ds.city_code and xc.city_level = 4) as city_name,
			 (select xc.district_name from xt_city xc  where xc.district_code = ds.district_code and xc.city_level = 5) as district_name,
			 (select CONCAT(dmt1.name,"-",dmt.name) from db_media_type dmt  left join db_media_type dmt1 on dmt.father_id = dmt1.media_type_id
				where ds.type = dmt.media_type_id) as media_name,
				ds.number,ds.is_illumine,ds.relegation,ds.moble,
		 ds.address,ds.show_type,ds.position, DATE_FORMAT(ds.create_time,'%Y-%m-%d %H:%i') as create_time,ds.imgs,
		 jvs.vendor_id,jvs.is_del
		 from 
		 db_space ds left join  j_vendor_space jvs
		  on jvs.space_id = ds.space_id AND jvs.vendor_id = #{vendor_id} AND jvs.is_del = 0
		 <where>
		 	<if test="name !='' and name !=null">
		 		ds.name LIKE CONCAT("%",#{name},"%") AND
		 	</if>
		 	<if test="province_code !='' and province_code !=null and province_code !='-1' ">
		 		ds.province_code = #{province_code}  AND
		 	</if>
		 	<if test="city_code !='' and city_code !=null and city_code !='-1'">
		 		ds.city_code = #{city_code}  AND
		 	</if>
		 	<if test="district_code !='' and district_code !=null and district_code !='-1' ">
		 		ds.district_code = #{district_code}  AND
		 	</if>
		 	<if test="type !='' and type !=null and type !='-1' ">
		 		ds.type = #{type}  AND
		 	</if>
		 	<if test="father_type !='' and father_type !=null and father_type !='-1' ">
		 		ds.first_type = #{father_type}  AND
		 	</if>
		 	<if test="address !='' and address !=null">
		 		ds.address LIKE CONCAT("%",#{address},"%") AND
		 	</if>
		 	<if test="create_btime != null and create_btime != ''">
                ds.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00') AND
            </if>
            <if test="create_etime != null and create_etime != ''">
                ds.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59') AND
            </if>
            1=1
            </where>
          ) as T
          WHERE T.vendor_id IS NULL AND T.is_del IS NULL
		  order by T.space_id desc
		 <if test="havePage == 1">
            LIMIT #{start},#{rows}
        </if>
	</select>
	
	
    
</mapper>