<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hmrz.mybatis.report">
    <select id="countPlan" resultType="int" parameterType="ReportPlanSearch">
        SELECT
		  COUNT(*)
		FROM report_plan rp
		WHERE rp.is_del = 0
		AND vendor_id = #{vendor_id}
		<if test="create_btime != null and create_btime != ''">
            AND rp.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
        </if>
        <if test="create_etime != null and create_etime != ''">
            AND rp.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
        </if>
        <if test="name != null and name != ''">
            AND rp.name like CONCAT('%', #{name},'%')
        </if>
    </select>
    
    <select id="listPlan" resultType="ReportPlanBean" parameterType="ReportPlanSearch">
        SELECT
          rp.plan_id AS id,
		  rp.name,
		  rp.vendor_id,
		  rp.salary,
		  rp.create_time,
		  rp.group_id,
		  rp.water_marker AS has_marked,
		  rp.is_admin,
		  rp.is_publish AS status,
		  (SELECT
		      COUNT(*)
		    FROM report_plan_space rps
		    WHERE rps.plan_id = rp.plan_id
		    AND rps.is_del = 0) AS total_points,
		  (SELECT
		      COUNT(*)
		    FROM (SELECT
		        rps.*
		      FROM report_plan_space rps,
		           report_plan_execute rpe
		      WHERE rps.plan_space_id = rpe.plan_space_id
		      AND rpe.status = 4
		      AND rps.is_del = 0
		      GROUP BY rps.plan_space_id) T
		    WHERE 1 = 1
		    AND T.plan_id = rp.plan_id) AS report_points,
		  (SELECT
		      COUNT(*)
		    FROM report_plan_execute rpe
		    WHERE rpe.plan_id = rp.plan_id
		    AND rpe.status = 4) AS total_report,
		  (SELECT
		      COUNT(*)
		    FROM (SELECT
		        rps.*
		      FROM report_plan_space rps,
		           report_plan_execute rpe
		      WHERE rps.plan_space_id = rpe.plan_space_id
		      AND rpe.status = 4
		      AND rps.is_del = 0
		      AND rpe.is_normal = 1
		      GROUP BY rps.plan_space_id) T
		    WHERE T.plan_id = rp.plan_id) AS abnormal_points
        FROM report_plan rp
        WHERE rp.is_del = 0
        AND vendor_id = #{vendor_id}
        <if test="create_btime != null and create_btime != ''">
            AND rp.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
        </if>
        <if test="create_etime != null and create_etime != ''">
            AND rp.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
        </if>
        <if test="name != null and name != ''">
            AND rp.name like CONCAT('%', #{name},'%')
        </if>
        ORDER BY rp.plan_id DESC
        <if test="havePage == 1">
            LIMIT #{start} , #{rows}
        </if>
    </select>
    
    <insert id="addPlan" parameterType="ReportPlanBean" useGeneratedKeys="true" keyProperty="id">
        <choose>
            <when test="group_id != null and group_id != ''">
                INSERT INTO report_plan(vendor_id, name, water_marker, salary, group_id, is_admin, create_time, create_user)
                VALUE(#{vendor_id}, #{name}, #{has_marked}, #{salary}, #{group_id}, 1, NOW(), #{create_user})
            </when>
            <otherwise>
                INSERT INTO report_plan(vendor_id, name, water_marker, salary, is_admin, create_time, create_user)
                VALUE(#{vendor_id}, #{name}, #{has_marked}, #{salary}, 1, NOW(), #{create_user})
            </otherwise>
        </choose>
    </insert>
    
    <update id="modifyPlan" parameterType="ReportPlanBean">
        UPDATE report_plan 
        SET name = #{name},
            water_marker = #{has_marked}
            ,salary = #{salary}
            <if test="group_id != null and group_id != ''">
            ,group_id = #{group_id}
            </if>
        WHERE plan_id = #{id}
        AND is_admin = 1
    </update>
    
    <update id="delPlan" parameterType="ReportPlanSearch">
        UPDATE report_plan SET is_del = 1 WHERE plan_id = #{plan_id}
    </update>
    
    <update id="switchStatus" parameterType="ReportPlanBean">
        UPDATE report_plan SET is_publish = #{status} WHERE plan_id = #{id}
    </update>
    
    <select id="countVendorPoint" resultType="int" parameterType="ReportPointSearch">
        SELECT
		  COUNT(*)
		FROM report_vendor_space rvs,
		     db_space ds,
		     xt_city xc
		WHERE rvs.vendor_id = #{vendor_id}
		AND rvs.is_del = 0
		AND rvs.space_id = ds.space_id
        AND xc.city_level = 4
        AND xc.province_code = ds.province_code
        AND xc.city_code = ds.city_code
		<if test="rename != null and rename != ''">
		  AND rvs.`rename` LIKE CONCAT('%', #{rename}, '%')
		</if>
		<if test="province_id != null and province_id !='' and province_id !='-1'">
          AND ds.province_code = #{province_id}
        </if>
        <if test="city_id != null and city_id !='' and city_id !='-1' ">
          AND ds.city_code = #{city_id}
        </if>
    </select>
    
    <select id="listVendorPoint" resultType="ReportPointBean" parameterType="ReportPointSearch">
        SELECT
          rvs.vendor_space_id AS id,
		  rvs.vendor_id,
		  ds.name,
		  ds.address,
		  rvs.`rename`,
		  xc.province_name AS province,
		  xc.city_name AS city,
		  (SELECT
		      dmt.name
		    FROM db_media_type dmt
		    WHERE dmt.media_type_id = ds.first_type) AS first_type,
		  (SELECT
		      dmt.name
		    FROM db_media_type dmt
		    WHERE dmt.media_type_id = ds.type) AS second_type,
		  ds.position
        FROM report_vendor_space rvs,
             db_space ds,
             xt_city xc
        WHERE rvs.vendor_id = #{vendor_id}
        AND rvs.is_del = 0
        AND rvs.space_id = ds.space_id
        AND xc.city_level = 4
        AND xc.province_code = ds.province_code
        AND xc.city_code = ds.city_code
        <if test="point_name != null and point_name != ''">
          AND ds.name LIKE CONCAT('%', #{point_name}, '%')
        </if>
        <if test="province_id != null and province_id !='' and province_id !='-1'">
          AND ds.province_code = #{province_id}
        </if>
        <if test="city_id != null and city_id !='' and city_id !='-1' ">
          AND ds.city_code = #{city_id}
        </if>
        <if test="havePage == 1">
            LIMIT #{start} , #{rows}
        </if>
    </select>
    
    <update id="renameVendorPoint" parameterType="ReportPointBean">
        UPDATE report_vendor_space SET `rename` = #{rename} WHERE vendor_space_id = #{id}
    </update>
    
    <update id="delVendorPoint" parameterType="ReportPointBean">
        UPDATE report_vendor_space SET is_del = 1 WHERE vendor_space_id = #{id}
    </update>
    
    <insert id="addVendorPoint" parameterType="ReportPointBean">
        INSERT INTO report_vendor_space (space_id, vendor_id, create_time, create_user)
        VALUE(#{space_id}, #{vendor_id}, NOW(), #{create_user})
    </insert>
    
    <select id="countPlanPoint" parameterType="ReportPointSearch" resultType="int">
        SELECT
		  COUNT(*)
		FROM report_plan_space rps,
		     report_vendor_space rvs,
		     db_space ds,
		     xt_city xc
		WHERE rps.plan_id = #{plan_id}
		AND rps.is_del = 0
		AND rps.vendor_space_id = rvs.vendor_space_id
		AND rvs.space_id = ds.space_id
		AND xc.city_level = 4
		AND xc.province_code = ds.province_code
		AND xc.city_code = ds.city_code
		<if test="point_name != null and point_name != ''">
          AND ds.name LIKE CONCAT('%', #{point_name}, '%')
        </if>
        <if test="province_id != null and province_id !='' and province_id !='-1'">
          AND ds.province_code = #{province_id}
        </if>
        <if test="city_id != null and city_id !='' and city_id !='-1' ">
          AND ds.city_code = #{city_id}
        </if>
    </select>
    
    <select id="listPlanPoint" resultType="ReportPointBean" parameterType="ReportPointSearch">
        SELECT
          rps.plan_space_id AS id,
		  ds.name,
		  ds.address,
		  rvs.`rename`,
		  xc.province_name AS province,
		  xc.city_name AS city,
		  rps.is_remove,
		  (SELECT
		      dmt.name
		    FROM db_media_type dmt
		    WHERE dmt.media_type_id = ds.first_type) AS first_type,
		  (SELECT
		      dmt.name
		    FROM db_media_type dmt
		    WHERE dmt.media_type_id = ds.type) AS second_type,
		  ds.position,
		  (SELECT
		      COUNT(*)
		    FROM report_plan_execute rpe
		    WHERE rpe.plan_space_id = rps.plan_space_id
		    AND rpe.status = 4) AS report_nums,
		  (SELECT
		      COUNT(*)
		    FROM report_plan_execute rpe
		    WHERE rpe.plan_space_id = rps.plan_space_id
		    AND rpe.status = 4
		    AND rpe.is_normal = 0) AS abnormal_nums
        FROM report_plan_space rps,
             report_vendor_space rvs,
             db_space ds,
             xt_city xc
        WHERE rps.plan_id = #{plan_id}
        AND rps.is_del = 0
        AND rps.vendor_space_id = rvs.vendor_space_id
        AND rvs.space_id = ds.space_id
        AND xc.city_level = 4
        AND xc.province_code = ds.province_code
        AND xc.city_code = ds.city_code
        <if test="point_name != null and point_name != ''">
          AND ds.name LIKE CONCAT('%', #{point_name}, '%')
        </if>
        <if test="province_id != null and province_id !='' and province_id !='-1'">
          AND ds.province_code = #{province_id}
        </if>
        <if test="city_id != null and city_id !='' and city_id !='-1' ">
          AND ds.city_code = #{city_id}
        </if>
        <if test="havePage == 1">
            LIMIT #{start} , #{rows}
        </if>
    </select>
    
    <select id="countPlanPointChoose" parameterType="DBSpaceSearch" resultType="int">
        SELECT
		  COUNT(*)
		FROM db_space ds,
		     report_vendor_space rvs
		WHERE rvs.space_id = ds.space_id
		AND rvs.vendor_id = #{vendor_id}
		<if test="name !='' and name !=null">
            AND ds.name LIKE CONCAT("%",#{name},"%")
        </if>
        <if test="province_code !='' and province_code !=null and province_code !='-1' ">
            AND ds.province_code = #{province_code}
        </if>
        <if test="city_code !='' and city_code !=null and city_code !='-1'">
            AND ds.city_code = #{city_code}
        </if>
        <if test="district_code !='' and district_code !=null and district_code !='-1' ">
            AND ds.district_code = #{district_code}
        </if>
        <if test="type !='' and type !=null and type !='-1' ">
            AND ds.type = #{type}
        </if>
        <if test="father_type !='' and father_type !=null and father_type !='-1' ">
            AND ds.first_type = #{father_type}
        </if>
        <if test="address !='' and address !=null">
            AND ds.address LIKE CONCAT("%",#{address},"%")
        </if>
        <if test="create_btime != null and create_btime != ''">
            AND ds.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
        </if>
        <if test="create_etime != null and create_etime != ''">
            AND ds.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
        </if>
		AND NOT EXISTS (SELECT
		    *
		  FROM report_plan_space rps
		  WHERE rps.vendor_space_id = rvs.vendor_space_id
		  AND rps.plan_id = #{plan_id}
		  AND rps.is_del = 0)
    </select>
    
    <select id="listPlanPointChoose" parameterType="DBSpaceSearch" resultType="DBSpaceBean">
        SELECT
          rvs.vendor_space_id,
          ds.space_id,
		  ds.name,
		  (SELECT
		      xc.city_name
		    FROM xt_city xc
		    WHERE xc.city_code = ds.city_code
		    AND xc.city_level = 4) AS city_name,
		  (SELECT
		      xc.district_name
		    FROM xt_city xc
		    WHERE xc.district_code = ds.district_code
		    AND xc.city_level = 5) AS district_name,
		  (SELECT
		      CONCAT(dmt1.name, "-", dmt.name)
		    FROM db_media_type dmt
		      LEFT JOIN db_media_type dmt1
		        ON dmt.father_id = dmt1.media_type_id
		    WHERE ds.type = dmt.media_type_id) AS media_name,
		  ds.number,
		  ds.moble,
		  ds.address,
		  ds.show_type,
		  ds.position,
		  rvs.`rename` AS imgs
        FROM db_space ds,
             report_vendor_space rvs
        WHERE rvs.space_id = ds.space_id
        AND rvs.vendor_id = #{vendor_id}
        <if test="name !='' and name !=null">
            AND ds.name LIKE CONCAT("%",#{name},"%")
        </if>
        <if test="province_code !='' and province_code !=null and province_code !='-1' ">
            AND ds.province_code = #{province_code}
        </if>
        <if test="city_code !='' and city_code !=null and city_code !='-1'">
            AND ds.city_code = #{city_code}
        </if>
        <if test="district_code !='' and district_code !=null and district_code !='-1' ">
            AND ds.district_code = #{district_code}
        </if>
        <if test="type !='' and type !=null and type !='-1' ">
            AND ds.type = #{type}
        </if>
        <if test="father_type !='' and father_type !=null and father_type !='-1' ">
            AND ds.first_type = #{father_type}
        </if>
        <if test="address !='' and address !=null">
            AND ds.address LIKE CONCAT("%",#{address},"%")
        </if>
        <if test="create_btime != null and create_btime != ''">
            AND ds.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
        </if>
        <if test="create_etime != null and create_etime != ''">
            AND ds.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
        </if>
        AND NOT EXISTS (SELECT
            *
          FROM report_plan_space rps
          WHERE rps.vendor_space_id = rvs.vendor_space_id
          AND rps.plan_id = #{plan_id}
          AND rps.is_del = 0)
       ORDER BY  ds.space_id DESC
       <if test="havePage == 1">
            LIMIT #{start} , #{rows}
       </if>
    </select>
    
    <insert id="addPlanPoint" parameterType="ReportPointBean">
        INSERT INTO report_plan_space(vendor_space_id, plan_id, create_time, create_user)
        VALUE (#{space_id}, #{plan_id}, NOW(), #{create_user}) 
    </insert>
    
    <update id="delPlanPoint" parameterType="ReportPointBean">
        UPDATE report_plan_space rps
		SET rps.is_del = 1
		WHERE rps.plan_space_id = #{id}
		AND NOT EXISTS (SELECT
		    *
		  FROM report_plan_execute rpe
		  WHERE rpe.plan_space_id = rps.plan_space_id)
    </update>
    
    <update id="showORhide" parameterType="ReportPointBean">
        UPDATE report_plan_space rps
        SET rps.is_remove = #{status}
        WHERE rps.plan_space_id = #{id}
    </update>
    
    <resultMap type="ReportExportBean" id="exportMap">
        <id column="plan_space_id" property="plan_space_id" />
        <result column="name" property="name"/>
        <result column="address" property="address"/>
        <result column="province" property="province"/>
        <result column="city" property="city"/>
        <result column="first_type" property="first_type" />
        <result column="second_type" property="second_type" />
        <result column="position" property="position"/>
        <result column="report_nums" property="report_nums"/>
        <result column="abnormal_nums" property="abnormal_nums"/>
        <collection property="result" ofType="ReportResultExportBean" >
            <result property="execute_id" column="execute_id" />
            <result property="upload_time" column="upload_time" />
            <result property="imgs"  column="imgs" />
            <result property="is_normal"  column="is_normal" />
        </collection>
    </resultMap>
    
    <select id="exportPlanPoint" parameterType="ReportPointSearch" resultMap="exportMap">
        SELECT
		  rps.plan_space_id,
		  ds.name,
		  rvs.`rename`,
		  ds.address,
		  xc.province_name AS province,
		  xc.city_name AS city,
		  (SELECT
		      dmt.name
		    FROM db_media_type dmt
		    WHERE dmt.media_type_id = ds.first_type) AS first_type,
		  (SELECT
		      dmt.name
		    FROM db_media_type dmt
		    WHERE dmt.media_type_id = ds.type) AS second_type,
		  ds.position,
		  (SELECT
		      COUNT(*)
		    FROM report_plan_execute rpe
		    WHERE rpe.plan_space_id = rps.plan_space_id
		    AND rpe.status = 4) AS report_nums,
		  (SELECT
		      COUNT(*)
		    FROM report_plan_execute rpe
		    WHERE rpe.plan_space_id = rps.plan_space_id
		    AND rpe.status = 4
		    AND rpe.is_normal = 0) AS abnormal_nums,
		  rpe.execute_id,
		  rpe.upload_time,
		  rpe.is_normal,
		  rpe.answer AS imgs
		FROM report_plan_space rps
		       LEFT JOIN report_plan_execute rpe
		         ON rpe.plan_space_id = rps.plan_space_id
		         AND rpe.status = 4,
		     report_vendor_space rvs,
		     db_space ds,
		     xt_city xc
		WHERE rps.plan_id = #{plan_id}
		AND rps.is_del = 0
		AND rps.vendor_space_id = rvs.vendor_space_id
		AND rvs.space_id = ds.space_id
		AND xc.city_level = 4
		AND xc.province_code = ds.province_code
		AND xc.city_code = ds.city_code
		<if test="point_name != null and point_name != ''">
          AND ds.name LIKE CONCAT('%', #{point_name}, '%')
        </if>
        <if test="province_id != null and province_id !='' and province_id !='-1'">
          AND ds.province_code = #{province_id}
        </if>
        <if test="city_id != null and city_id !='' and city_id !='-1' ">
          AND ds.city_code = #{city_id}
        </if>
    </select>
    
</mapper>