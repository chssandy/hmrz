<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hmrz.mybatis.sign">
	
	<select id="getSignCouponRuleList" resultType="SignCouponRuleBean">
		select rule_id,b_day,e_day,denomination,validity_period,min_amount,rate,denomination_one,validity_period_one,min_amount_one,rate_one
		from s_rule_sign_in		
	</select>
	
	<insert id="addSignCouponRule" parameterType="SignCouponRuleBean">
		insert into s_rule_sign_in(b_day,e_day,denomination,validity_period,min_amount,rate,denomination_one,validity_period_one,min_amount_one,rate_one,create_user)
		values (#{b_day},#{e_day},#{denomination},#{validity_period},#{min_amount},#{rate},#{denomination_one},#{validity_period_one},#{min_amount_one},#{rate_one},#{create_user})
	</insert>
	
	<delete id="deleteSignCouponRule" parameterType="int">
		delete from s_rule_sign_in 
	</delete>
	
	<select id="getSignCouponList" parameterType="AppCouponSearch" resultType="AppCouponBean">
	
			SELECT au.moble,au.nick_name,ac.coupon_id,
			asi.continue_days,
			ac.denomination,ac.min_amount,ac.create_time,ac.validity_period,ac.is_used
			FROM app_coupon ac 
			LEFT JOIN app_user au ON ac.user_id = au.user_id 
			LEFT JOIN app_sign_in asi ON ac.coupon_id = asi.coupon_id
			WHERE ac.type = 0
			<if test="moble != null and moble !='' ">
				AND au.moble = #{moble}
			</if>
			<if test="nick_name != null and nick_name !='' ">
				AND au.nick_name LIKE CONCAT("%",#{nick_name},"%")
			</if>
			<if test="create_btime != null and create_btime !='' ">
			 	AND ac.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
			</if>
			<if test="create_etime != null and create_etime !='' ">
			 	AND ac.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
			</if>
			<if test='is_used == "0" '>
                AND ac.is_used = 0
                AND ac.validity_period >= NOW()
            </if>
            <if test='is_used == "1" '>
                AND ac.is_used = 1
            </if>
			<if test='is_used == "2" '>
			    AND ac.is_used = 0
				AND ac.validity_period &lt; NOW()
			</if>
			<if test=" b_continue_days!= null and b_continue_days !='' ">
				AND asi.continue_days &gt;= #{b_continue_days}
			</if>
			<if test=" e_continue_days!= null and e_continue_days !='' ">
				AND asi.continue_days &lt;= #{e_continue_days}
			</if>
			ORDER BY ac.create_time
			<if test="havePage == 1">
            	LIMIT #{start},#{rows}
        	</if>
        	
	</select>
	
	<select id="getSignCouponCount" parameterType="AppCouponSearch" resultType="int">
	
			SELECT COUNT(1)
			FROM app_coupon ac 
			LEFT JOIN app_user au ON ac.user_id = au.user_id 
			LEFT JOIN app_sign_in asi ON ac.coupon_id = asi.coupon_id
			where ac.type = 0
			<if test="moble != null and moble !='' ">
				AND au.moble = #{moble}
			</if>
			<if test="nick_name != null and nick_name !='' ">
				AND au.nick_name LIKE CONCAT("%",#{nick_name},"%")
			</if>
			<if test="create_btime != null and create_btime !='' ">
			 	AND ac.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
			</if>
			<if test="create_etime != null and create_etime !='' ">
			 	AND ac.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
			</if>
			<if test='is_used == "0" '>
                AND ac.is_used = 0
                AND ac.validity_period >= NOW()
            </if>
            <if test='is_used == "1" '>
                AND ac.is_used = 1
            </if>
            <if test='is_used == "2" '>
                AND ac.is_used = 0
                AND ac.validity_period &lt; NOW()
            </if>
			<if test=" b_continue_days!= null and b_continue_days !='' ">
				AND asi.continue_days &gt;= #{b_continue_days}
			</if>
			<if test=" e_continue_days!= null and e_continue_days !='' ">
				AND asi.continue_days &lt;= #{e_continue_days}
			</if>
	</select>
	
	<select id="getSignCouponSum" parameterType="AppCouponSearch" resultType="String">
			SELECT SUM(ac.denomination)
			FROM app_coupon ac 
			LEFT JOIN app_user au ON ac.user_id = au.user_id 
			LEFT JOIN app_sign_in asi ON ac.coupon_id = asi.coupon_id
			where ac.type = 0
			<if test="moble != null and moble !='' ">
				AND au.moble = #{moble}
			</if>
			<if test="nick_name != null and nick_name !='' ">
				AND au.nick_name LIKE CONCAT("%",#{nick_name},"%")
			</if>
			<if test="create_btime != null and create_btime !='' ">
			 	AND ac.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
			</if>
			<if test="create_etime != null and create_etime !='' ">
			 	AND ac.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
			</if>
			<if test='is_used == "0" '>
                AND ac.is_used = 0
                AND ac.validity_period >= NOW()
            </if>
            <if test='is_used == "1" '>
                AND ac.is_used = 1
            </if>
            <if test='is_used == "2" '>
                AND ac.is_used = 0
                AND ac.validity_period &lt; NOW()
            </if>
			<if test=" b_continue_days!= null and b_continue_days !='' ">
				AND asi.continue_days &gt;= #{b_continue_days}
			</if>
			<if test=" e_continue_days!= null and e_continue_days !='' ">
				AND asi.continue_days &lt;= #{e_continue_days}
			</if>
	</select>
	
	
	<select id="getSignCouponUseList" parameterType="AppCouponSearch" resultType="AppCouponBean">
		
		SELECT au.moble,au.nick_name,ac.coupon_id,ac.used_time,ac.denomination,ac.task_biz,ac.execute_id,ac.task_id,
		CASE ac.task_biz 
		 	WHEN 1 THEN (SELECT sm.name FROM s_monitor sm WHERE sm.task_id = ac.task_id )  
			WHEN 2 THEN (SELECT sm.name FROM s_share_wx sm WHERE sm.task_id = ac.task_id)  
		 	WHEN 3 THEN (SELECT sm.name FROM s_media sm WHERE sm.task_id = ac.task_id)  
		 	WHEN 4 THEN (SELECT sm.name FROM s_inspecte sm WHERE sm.task_id = ac.task_id)  
		 	WHEN 5 THEN (SELECT sm.name FROM s_media sm WHERE sm.task_id = ac.task_id)  
		 	WHEN 6 THEN (SELECT sm.name FROM s_survey sm WHERE sm.task_id = ac.task_id) 
		 	END AS task_name
 		FROM app_coupon ac 
		LEFT JOIN app_user au on ac.user_id = au.user_id
		WHERE ac.type = 0 AND ac.is_used = 1 
		<if test=" moble !=null and moble !='' ">
			AND au.moble = #{moble}
		</if>
		<if test=" nick_name !=null and nick_name !='' ">
			AND au.nick_name LIKE CONCAT("%",#{nick_name},"%")
		</if>
		<if test="create_btime != null and create_btime !='' ">
		 	AND ac.used_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
		</if>
		<if test="create_etime != null and create_etime !='' ">
		 	AND ac.used_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
		</if>
		ORDER BY ac.used_time DESC
		<if test="havePage == 1">
           	LIMIT #{start},#{rows}
       	</if>
	</select>
	
	<select id="getSignCouponUseCount" parameterType="AppCouponSearch" resultType="int">
		
		SELECT COUNT(1)
 		FROM app_coupon ac 
		LEFT JOIN app_user au on ac.user_id = au.user_id
		WHERE ac.type = 0 AND ac.is_used = 1 
		<if test=" moble !=null and moble !='' ">
			AND au.moble = #{moble}
		</if>
		<if test=" nick_name !=null and nick_name !='' ">
			AND au.nick_name LIKE CONCAT("%",#{nick_name},"%")
		</if>
		<if test="create_btime != null and create_btime !='' ">
		 	AND ac.used_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
		</if>
		<if test="create_etime != null and create_etime !='' ">
		 	AND ac.used_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
		</if>
	</select>
	
	<select id="getSignCouponUseSum" parameterType="AppCouponSearch" resultType="String">
		SELECT SUM(ac.denomination)
 		FROM app_coupon ac 
		LEFT JOIN app_user au on ac.user_id = au.user_id
		WHERE ac.type = 0 AND ac.is_used = 1 
		<if test=" moble !=null and moble !='' ">
			AND au.moble = #{moble}
		</if>
		<if test=" nick_name !=null and nick_name !='' ">
			AND au.nick_name LIKE CONCAT("%",#{nick_name},"%")
		</if>
		<if test="create_btime != null and create_btime !='' ">
		 	AND ac.used_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
		</if>
		<if test="create_etime != null and create_etime !='' ">
		 	AND ac.used_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
		</if>
	</select>
	
</mapper>