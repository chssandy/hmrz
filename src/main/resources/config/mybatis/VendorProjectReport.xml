<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hmrz.mybatis.vendorProjectReport">
    
	<select id="getMonitorReportList" parameterType="VendorProjectTaskSearch" resultType="MonitorResultBean">
        SELECT
        	sm.task_id,
        	sm.name,
        	xc.city_name as exe_city,
        	DATE_FORMAT(sm.do_btime,'%Y-%m-%d %H:%i') as do_btime,
        	DATE_FORMAT(sm.do_etime,'%Y-%m-%d %H:%i') as do_etime,
        	sme.is_passed,
        	sme.passed_reason,
        	sme.execute_id,
        	(select brand_name from s_brand where brand_id =sm.brand_id) as brand_name,
        	( SELECT GROUP_CONCAT(CONCAT(task_aim_name,":",aim_value)) FROM S_MONITOR_AIM SMA 
				LEFT JOIN S_TASK_AIM STA ON SMA.aim_id = STA.task_aim_id WHERE SMA.task_id = sm.task_id) AS aims,
			sm.status
        FROM 
        	c_vendor_project_task cvpt LEFT JOIN s_monitor sm ON cvpt.task_id = sm.task_id
        	INNER JOIN s_monitor_execute sme ON sm.task_id =sme.task_id AND sme.`status` = 4
        	INNER JOIN s_monitor_city smc ON sm.task_id = smc.task_id
        	LEFT JOIN xt_city xc ON smc.city_code = xc.city_code and smc.city_level = xc.city_level
        WHERE
        	 cvpt.project_id =#{project_id_search} AND sm.status = 4 
			ORDER BY cvpt.create_time desc
	</select>
	
	<select id="getInspecteReportList" parameterType="VendorProjectTaskSearch" resultType="InspecteResultBean">
        SELECT
        	sm.task_id,
        	sm.name,
        	xc.city_name as exe_city,
        	DATE_FORMAT(sm.do_btime,'%Y-%m-%d %H:%i') as do_btime,
        	DATE_FORMAT(sm.do_etime,'%Y-%m-%d %H:%i') as do_etime,
        	sme.is_passed,
        	sme.execute_id,
        	(select brand_name from s_brand where brand_id =sm.brand_id) as brand_name,
        	( SELECT GROUP_CONCAT(CONCAT(task_aim_name,":",aim_value)) FROM s_inspecte_aim SMA 
				LEFT JOIN S_TASK_AIM STA ON SMA.aim_id = STA.task_aim_id WHERE SMA.task_id = sm.task_id) AS aims,
			sm.status
        FROM 
        	c_vendor_project_task cvpt LEFT JOIN s_inspecte sm ON cvpt.task_id = sm.task_id
        	INNER JOIN s_inspecte_execute sme ON sm.task_id =sme.task_id AND sme.`status` = 4
        	INNER JOIN s_inspecte_city smc ON sm.task_id = smc.task_id
        	LEFT JOIN xt_city xc ON smc.city_code = xc.city_code and smc.city_level = xc.city_level
        WHERE
        	 cvpt.project_id =#{project_id_search} AND sm.status = 4 
			ORDER BY cvpt.create_time desc
	</select>
	
	<select id="getMediaReportList" parameterType="VendorProjectTaskSearch" resultType="MediaResultBean">
        SELECT
        	sm.task_id,
        	sm.name,
        	DATE_FORMAT(sm.do_btime,'%Y-%m-%d %H:%i') as do_btime,
        	DATE_FORMAT(sm.do_etime,'%Y-%m-%d %H:%i') as do_etime,
        	sm.execute_times,
        	( SELECT COUNT(1) FROM s_media_execute sme WHERE sme.task_id = sm.task_id and sme.status = 4 ) AS audit_pass,
        	sm.salary,
        	sm.status
        FROM 
        	c_vendor_project_task cvpt LEFT JOIN c_vendor_project cvp ON cvpt.project_id = cvp.project_id
        	LEFT JOIN s_media sm ON sm.task_type_id = cvp.task_type_id AND cvpt.task_id = sm.task_id 
        WHERE
            cvpt.project_id =#{project_id_search}
            AND sm.status &gt;= 4 AND sm.status &lt;=5 
			ORDER BY cvpt.create_time desc
	</select>
	
	<select id="getSharewxReportList" parameterType="VendorProjectTaskSearch" resultType="SharewxResultBean">
        SELECT
        	sm.task_id,
        	sm.name,
        	DATE_FORMAT(sm.do_btime,'%Y-%m-%d %H:%i') as do_btime,
        	DATE_FORMAT(sm.do_etime,'%Y-%m-%d %H:%i') as do_etime,
        	sm.execute_times,
        	(select count(*) from s_share_wx_data sswd where sswd.task_id = sm.task_id) as pv,
			(select count(*) from s_share_wx_data sswd where sswd.task_id = sm.task_id and sswd.click_salary>0) as uv,
        	sm.salary,
        	sm.status
        FROM 
        	c_vendor_project_task cvpt LEFT JOIN c_vendor_project cvp ON cvpt.project_id = cvp.project_id
        	LEFT JOIN s_share_wx sm ON cvpt.task_id = sm.task_id 
        WHERE
            cvpt.project_id =#{project_id_search}
            AND sm.status &gt;= 4 AND sm.status &lt;=5 
			ORDER BY cvpt.create_time desc
	</select>
	
	<select id="getSurveyReportList" parameterType="VendorProjectTaskSearch" resultType="SurveyResultBean">
        SELECT
        	sm.task_id,
        	sm.name,
        	DATE_FORMAT(sm.do_btime,'%Y-%m-%d %H:%i') as do_btime,
        	DATE_FORMAT(sm.do_etime,'%Y-%m-%d %H:%i') as do_etime,
        	sm.execute_times,
        	( SELECT COUNT(1) FROM s_survey_execute sme WHERE sme.task_id = sm.task_id ) AS total_recovery,
        	( SELECT COUNT(1) FROM s_survey_execute sme WHERE sme.task_id = sm.task_id and sme.status = 4 ) AS audit_pass,
        	sm.salary,
        	sm.status
        FROM 
        	c_vendor_project_task cvpt LEFT JOIN c_vendor_project cvp ON cvpt.project_id = cvp.project_id
        	LEFT JOIN s_survey sm ON sm.task_type_id = cvp.task_type_id AND cvpt.task_id = sm.task_id 
        WHERE
            cvpt.project_id =#{project_id_search}
            AND sm.status &gt;= 4 AND sm.status &lt;=5 
			ORDER BY cvpt.create_time desc
	</select>
	
</mapper>