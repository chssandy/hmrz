<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hmrz.mybatis.userBalance">
	<!-- 结算申请 -->
	<select id="getBalanceList" parameterType="UserBalanceSearch" resultType="UserBalanceBean">
        SELECT
        	AUB.balance_id,
        	AU.nick_name,
        	AU.moble,
        	AUB.charge_moble,
        	AU.account as balance_account,
			AU.account_name as balance_user,
			AUB.balance_num,
			AUB.handling_charge,
			AU.balance as balance_residue,
			AUB.balance_time,
			AUB.audit_time,
			AUB.status,
			XC.district_name as district,
            XC.city_name as city
        FROM 
        	APP_USER_BALANCE AUB ,APP_USER AU
        	LEFT JOIN XT_CITY XC ON AU.city = XC.district_code AND XC.city_level = 5
        WHERE
            AUB.balance_user = AU.user_id
           	 <if test="status != null and status != ''">
           		AND AUB.status = #{status}
           	 </if>
           	 <if test="status == null or status == '' ">
           		AND AUB.status > 0
           	 </if>
            AND AUB.type = #{type}
            <if test="apply_btime != null and apply_btime != ''">
                AND AUB.balance_time &gt;= CONCAT(#{apply_btime}, ' 00:00:00')
            </if>
            <if test="apply_etime != null and apply_etime != ''">
                AND AUB.balance_time &lt;= CONCAT(#{apply_etime}, ' 23:59:59')
            </if>
            <if test="apply_user_id != null and apply_user_id != ''">
                AND AUB.balance_user &lt;= #{apply_user_id}
            </if>
            <if test="apply_user_name != null and apply_user_name != ''">
                AND AU.account_name LIKE CONCAT('%',#{apply_user_name},'%')
            </if>
            <if test="audit_btime != null and audit_btime != ''">
                AND AUB.audit_time &gt;= CONCAT(#{audit_btime}, ' 00:00:00')
            </if>
            <if test="audit_etime != null and audit_etime != ''">
                AND AUB.audit_time &lt;= CONCAT(#{audit_etime}, ' 23:59:59')
            </if>
            <if test="nick_name != null and nick_name != ''">
                AND AU.nick_name LIKE CONCAT('%',#{nick_name},'%')
            </if>
            <if test="account != null and account != ''">
                AND AU.account = #{account}
            </if>
            <if test="moble != null and moble != ''">
                AND AU.moble = #{moble}
            </if>
            <choose>
                <when test="province_code != null and province_code != '' and (city_code == null or city_code == '')">
                    AND XC.province_code = #{province_code}
                </when>
                <when test="city_code != null and city_code != '' and (district_code == null or district_code == '')">
                    AND XC.city_code = #{city_code}
                </when>
                <when test="district_code != null and district_code != ''">
                    AND XC.district_code = #{district_code} 
                </when>
            </choose>
            ORDER BY 
            <choose>
            	<when test="status == 0">
            		AUB.balance_time
            	</when>
            	<otherwise>
            		AUB.balance_time DESC
            	</otherwise>
            </choose>
	        <if test="havePage == 1">
	        	LIMIT #{start} , #{rows}
	        </if>
	</select>
	
	<select id="getBalanceCount" parameterType="UserBalanceSearch" resultType="int">
        SELECT
        	count(AUB.balance_id)
        FROM 
        	APP_USER_BALANCE AUB,APP_USER AU
        	LEFT JOIN XT_CITY XC ON AU.city = XC.district_code AND XC.city_level = 5
        WHERE
            AUB.balance_user = AU.user_id
            <if test="status != null and status != ''">
           		AND AUB.status = #{status}
           	</if>
           	<if test="status == null or status == '' ">
           		AND AUB.status > 0
           	</if>
            AND AUB.type = #{type}
            <if test="apply_btime != null and apply_btime != ''">
                AND AUB.balance_time &gt;= CONCAT(#{apply_btime}, ' 00:00:00')
            </if>
            <if test="apply_etime != null and apply_etime != ''">
                AND AUB.balance_time &lt;= CONCAT(#{apply_etime}, ' 23:59:59')
            </if>
            <if test="apply_user_id != null and apply_user_id != ''">
                AND AUB.balance_user &lt;= #{apply_user_id}
            </if>
            <if test="apply_user_name != null and apply_user_name != ''">
                AND AU.account_name LIKE CONCAT('%',#{apply_user_name},'%')
            </if>
             <if test="audit_btime != null and audit_btime != ''">
                AND AUB.audit_time &gt;= CONCAT(#{audit_btime}, ' 00:00:00')
            </if>
            <if test="audit_etime != null and audit_etime != ''">
                AND AUB.audit_time &lt;= CONCAT(#{audit_etime}, ' 23:59:59')
            </if>
            <if test="nick_name != null and nick_name != ''">
                AND AU.nick_name LIKE CONCAT('%',#{nick_name},'%')
            </if>
            <if test="account != null and account != ''">
                AND AU.account = #{account}
            </if>
            <if test="moble != null and moble != ''">
                AND AU.moble = #{moble}
            </if>
            <choose>
                <when test="province_code != null and province_code != '' and (city_code == null or city_code == '')">
                    AND XC.province_code = #{province_code}
                </when>
                <when test="city_code != null and city_code != '' and (district_code == null or district_code == '')">
                    AND XC.city_code = #{city_code}
                </when>
                <when test="district_code != null and district_code != ''">
                    AND XC.district_code = #{district_code} 
                </when>
            </choose>
	</select>
	
	<!-- 处理结算申请列表  每次最大1000条，从最开始提出的计算-->
	<select id="getAlipayBalanceList"  resultType="UserBalanceBean">
        SELECT
        	AUB.balance_id,
        	AU.nick_name,
        	AU.moble,
        	AU.account as balance_account,
			AU.account_name as balance_user,
			AUB.balance_num,
			AU.balance as balance_residue,
			AUB.balance_time,
			AUB.audit_time,
			AUB.status
        FROM 
        	APP_USER_BALANCE AUB ,APP_USER AU
        WHERE
            AUB.balance_user = AU.user_id
            AND AUB.type = 0 AND AUB.status = 0
            ORDER BY AUB.balance_id ASC
            LIMIT 0,1000
	</select>
	
	<!-- 处理结算申请列表超过48小时的打款中数据全部更新为打款失败-->
	<update id="doAlipayFailed" >
        UPDATE APP_USER_BALANCE AUB ,APP_USER AU
        set AUB.status = 3,audit_time = NOW(),auditor = 1, AU.balance = AU.balance+AUB.balance_num + AUB.handling_charge
		WHERE AUB.balance_user = AU.user_id 
		AND AUB.status = 2 AND AUB.type = 0
		AND (TO_DAYS(NOW())-TO_DAYS(AUB.audit_time)) &gt; 2
	</update>
	
	<!-- 结算申请  操作状态 -->
  	<update id="balanceAlipay" parameterType="java.util.Map">
  	    UPDATE APP_USER_BALANCE AUB ,APP_USER AU
        SET AUB.status = #{status},audit_time = NOW()
        <if test="auditor != null and auditor !='' ">
        ,AUB.auditor = #{auditor}
        </if>
        <if test="status == 3 ">
        ,AU.balance = AU.balance + AUB.balance_num + AUB.handling_charge
        </if>
        WHERE AUB.balance_user = AU.user_id
        <choose>  
	        <when test="status == 3">  
	            AND ((AUB.status = 2 AND AUB.type = 0) OR (AUB.status = 0 AND AUB.type = 1))
	        </when>  
	        <when test="status == 1">  
	            AND ((AUB.status = 2 AND AUB.type = 0) OR (AUB.status = 0 AND AUB.type = 1))
	        </when>  
	        <otherwise>  
	            AND AUB.status = 0
	        </otherwise>  
	    </choose>  
		AND AUB.balance_id in
		<foreach collection="id" item="item"  separator="," open="(" close=")">
		(#{item,jdbcType=VARCHAR})
        </foreach>
	</update>
	
  	<!-- 批量处理结算申请日志 -->
  	<insert id="addBalanceLog" parameterType="java.util.Map" useGeneratedKeys="true" keyProperty="batch_id">
        INSERT INTO APP_USER_BALANCE_LOG (
			batch_no,
			pay_date,
			notify_url,
			email,
			account_name,
			batch_fee,
			batch_num,
			detail_data,
			balance_ids,
			create_user
        )
        VALUES 
        (#{batch_no,jdbcType=VARCHAR},
         #{pay_date,jdbcType=VARCHAR},
         #{notify_url,jdbcType=VARCHAR},
         #{email,jdbcType=VARCHAR},
         #{account_name,jdbcType=VARCHAR},
         #{batch_fee,jdbcType=VARCHAR},
         #{batch_num,jdbcType=VARCHAR},
         #{detail_data,jdbcType=VARCHAR},
         #{balance_ids,jdbcType=VARCHAR},
         #{create_user,jdbcType=VARCHAR}
         )
    </insert>
    
  	<!-- 批量处理结算申请日志  返回值更新 -->
  	<update id="modifyBalanceLog" parameterType="java.util.Map" >
        UPDATE APP_USER_BALANCE_LOG SET
	        success_data = #{success_data},
	        success_ids = #{success_ids},
	        fail_data = #{fail_data},
	        fail_ids = #{fail_ids},
	        pay_account_no = #{pay_account_no},
	        back_time = NOW()
	    WHERE batch_no = #{batch_no} AND back_time is NULL
    </update>
    
  	<!-- 根据balanceId查询申请人相关信息 -->
  	<select id="getUserByBalanceId" parameterType="String" resultType="UserBean">
  	    SELECT au.user_id,au.moble,au.registration_id,au.platform,au.brand
  	    FROM app_user au ,app_user_balance aub
		WHERE aub.balance_user = au.user_id AND aub.balance_id = #{balance_id}
  	</select>
</mapper>