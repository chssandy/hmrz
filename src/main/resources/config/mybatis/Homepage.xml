<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hmrz.mybatis.homepage">
	
	<select id="getHomepageList" parameterType="HomepageSearch" resultType="HomepageBean">
		select ah.homepage_id,ah.name,ah.section_limit,ah.expose_times,ah.click_times,ah.valid_click_times,ah.status,ah.create_time 
		from app_homepage ah
		where ah.is_del = 0
		<if test="name !=null and name !='' ">
			and ah.name like concat("%",#{name},"%")
		</if>
		<if test="create_btime != null and create_btime != ''">
	    	and ah.create_time &gt; concat(#{create_btime}," 00:00:00")
	    </if>
	    <if test="create_etime != null and create_etime != ''">
	    	and ah.create_time &lt; concat(#{create_etime}," 23:59:59")
	    </if>
	    order by ah.homepage_id desc
	    <if test="havePage == 1">
            LIMIT #{start},#{rows}
        </if>
	</select>	
	
	<select id="getHomepageCount" parameterType="HomepageSearch" resultType="int">
		select count(1)
		from app_homepage ah
		where ah.is_del = 0
		<if test="name !=null and name !='' ">
			and ah.name like concat("%",#{name},"%")
		</if>
		<if test="create_btime != null and create_btime != ''">
	    	and ah.create_time &gt; concat(#{create_btime}," 00:00:00")
	    </if>
	    <if test="create_etime != null and create_etime != ''">
	    	and ah.create_time &lt; concat(#{create_etime}," 23:59:59")
	    </if>
	</select>	
	
	<select id="getHomepageByID" parameterType="String" resultMap="HomepageDetail">
		select ah.homepage_id,ah.name,ah.img_url,ah.link_url,ah.section_limit,
			ahc.city_code,ahc.city_level,
			DATE_FORMAT(ahc.show_btime,'%Y-%m-%d') show_btime,
			DATE_FORMAT(ahc.show_etime,'%Y-%m-%d') show_etime
		from app_homepage ah 
		left join app_homepage_city ahc on ah.homepage_id = ahc.homepage_id
		where ah.homepage_id = #{homepage_id} and ah.is_del = 0
	</select>
	
	<resultMap type="HomepageBean" id="HomepageDetail">
		<id column="homepage_id" property="homepage_id"/>
		<result column="name" property="name" />
		<result column="img_url" property="img_url" />
		<result column="link_url" property="link_url" />
		<result column="section_limit" property="section_limit" />
		<collection property="cityList" ofType="HomepageCityBean">
			<result column="city_code" property="city_code" />
			<result column="city_level" property="city_level" />
			<result column="show_btime" property="show_btime" />
			<result column="show_etime" property="show_etime" />
		</collection>
	</resultMap>
	
	<insert id="addHomepage" parameterType="HomepageBean" useGeneratedKeys="true" keyProperty="homepage_id">
		insert into app_homepage(name,img_url,link_url,section_limit) 
			values(#{name},#{img_url},#{link_url},#{section_limit})
	</insert>
	
	<insert id="addHomepageCity" parameterType="HomepageBean">
		insert into app_homepage_city(homepage_id,city_code,city_level,show_btime,show_etime) values
		<foreach collection="cityList" item="item" separator="," >
			(#{homepage_id},#{item.city_code},#{item.city_level},#{item.show_btime},#{item.show_etime})
		</foreach>
	</insert>
	
	<update id="updateHomepageStatus" parameterType="HomepageBean">
		update app_homepage set 
		<if test="status != null and status !='' ">
			status = #{status}
		</if>
		<if test="is_del != null and is_del !='' ">
			is_del = #{is_del}
		</if>
		where homepage_id = #{homepage_id}
	</update>
	
	<update id="updateHomepage" parameterType="HomepageBean">
		update app_homepage
		<set>
			name = #{name},
			img_url = #{img_url},
			link_url = #{link_url},
			section_limit = #{section_limit}
		</set>
		where homepage_id = #{homepage_id}
	</update>
	
	<delete id="deleteHomepageCity" parameterType="String">
		delete from app_homepage_city where homepage_id = #{homepage_id}
	</delete>
	
</mapper>