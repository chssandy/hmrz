<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hmrz.mybatis.user">

	<select id="getUserList" parameterType="UserSearch" resultType="UserBean">
        SELECT
		  AU.user_id,
		  AU.moble,
		  AU.nick_name,
		  AU.account,
		  AU.account_name,
		  AU.sex,
		  AU.qq,
		  AU.email,
		  AU.monitor_score,
		  AU.inspecte_score,
		  AU.balance,
		  AU.create_time,
		  AU.last_use_time,
		  AU.remark,
		  AU.occupation,
		  AU.sideline,
		  AU.birthday,
		  AU.platform,
		  (SELECT
		      xcd.score + xcd.total
		    FROM APP_CREDIT_DATA xcd
		    WHERE xcd.user_id = AU.user_id AND xcd.task_biz = 1) AS monitor_credit,
		  (SELECT
		      xcd.score + xcd.total
		    FROM APP_CREDIT_DATA xcd
		    WHERE xcd.user_id = AU.user_id AND xcd.task_biz = 4) AS inspecte_credit,
		  XC.district_name as district,
		  XC.city_name as city
		FROM APP_USER AU LEFT JOIN XT_CITY XC
    	ON AU.city = XC.district_code and XC.city_level = 5
		WHERE
        	AU.is_del = 0
            <if test="moble_search != null and moble_search != ''">
               AND AU.moble = #{moble_search}
            </if>
            <if test="nick_name_search != null and nick_name_search != ''">
               AND AU.nick_name LIKE CONCAT('%',#{nick_name_search},'%')
            </if>
            <choose>
            	<when test="province_code != null and province_code != '' and (city_code == null or city_code == '')">
            		AND XC.province_code = #{province_code}
            	</when>
            	<when test="city_code != null and city_code != '' and (district_code == null or district_code == '')">
            		AND XC.city_code = #{city_code}
            	</when>
            	<when test="district_code != null and district_code != ''">
            		AND XC.district_code = #{district_code} 
            	</when>
            </choose>
            <if test="registered_days_start != null and registered_days_start != ''">
            	AND (TO_DAYS(NOW()) - TO_DAYS(AU.create_time) &gt;= #{registered_days_start})
            </if>
            <if test="registered_days_end != null and registered_days_end != ''">
                AND (TO_DAYS(NOW()) - TO_DAYS(AU.create_time) &lt;= #{registered_days_end})
            </if>
            <if test="offline_days_start != null and offline_days_start != ''">
            	AND (TO_DAYS(NOW()) - TO_DAYS(AU.last_use_time) &gt;= #{offline_days_start})
            </if>
            <if test="offline_days_end != null and offline_days_end != ''">
                AND (TO_DAYS(NOW()) - TO_DAYS(AU.last_use_time) &lt;= #{offline_days_end})
            </if>
            <if test="create_btime != null and create_btime !='' ">
			 	AND AU.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
			</if>
			<if test="create_etime != null and create_etime !='' ">
			 	AND AU.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
			</if>
			<if test="remark != null and remark !='' ">
			 	AND AU.remark LIKE CONCAT("%",#{remark},"%")
			</if>
			<if test="sideline != null and sideline !='' ">
			 	AND AU.sideline LIKE CONCAT("%",#{sideline},"%")
			</if>
        ORDER BY create_time DESC
        <if test="havePage == 1">
            limit #{start},#{rows}
        </if> 
	</select>

    <select id="getUserCount" parameterType="UserSearch" resultType="int">
        SELECT
        	COUNT(*)
        FROM APP_USER AU LEFT JOIN XT_CITY XC
        ON AU.city = XC.district_code
        WHERE
        	AU.is_del = 0
            <if test="moble_search != null and moble_search != ''">
               AND AU.moble = #{moble_search}
            </if>
            <if test="nick_name_search != null and nick_name_search != ''">
               AND AU.nick_name LIKE CONCAT('%',#{nick_name_search},'%')
            </if>
            <choose>
            	<when test="province_code != null and province_code != '' and (city_code == null or city_code == '')">
            		AND XC.province_code = #{province_code}
            	</when>
            	<when test="city_code != null and city_code != '' and (district_code == null or district_code == '')">
            		AND XC.city_code = #{city_code}
            	</when>
            	<when test="district_code != null and district_code != ''">
            		AND XC.district_code = #{district_code} 
            	</when>
            </choose>
            <if test="registered_days_start != null and registered_days_start != ''">
            	AND (TO_DAYS(NOW()) - TO_DAYS(AU.create_time) &gt;= #{registered_days_start})
            </if>
            <if test="registered_days_end != null and registered_days_end != ''">
                AND (TO_DAYS(NOW()) - TO_DAYS(AU.create_time) &lt;= #{registered_days_end})
            </if>
            <if test="offline_days_start != null and offline_days_start != ''">
            	AND (TO_DAYS(NOW()) - TO_DAYS(AU.last_use_time) &gt;= #{offline_days_start})
            </if>
            <if test="offline_days_end != null and offline_days_end != ''">
                AND (TO_DAYS(NOW()) - TO_DAYS(AU.last_use_time) &lt;= #{offline_days_end})
            </if>
            <if test="create_btime != null and create_btime !='' ">
			 	AND AU.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00')
			</if>
			<if test="create_etime != null and create_etime !='' ">
			 	AND AU.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59')
			</if>
			<if test="remark != null and remark !='' ">
                AND AU.remark LIKE CONCAT("%",#{remark},"%")
            </if>
			<if test="sideline != null and sideline !='' ">
                AND AU.sideline LIKE CONCAT("%",#{sideline},"%")
            </if>
    </select>
        
    <!-- app用户备注信息维护 -->
   	<update id="remarkUser" parameterType="HashMap">
		UPDATE APP_USER SET remark = #{remark} WHERE user_id = #{user_id}
	</update>
	
	<update id="scoreUser" parameterType="UserBean">
		UPDATE APP_USER 
		<set>
			<if test="monitor_score !=null and monitor_score !='' ">
				monitor_score = #{monitor_score}+IFNULL(monitor_score,0)
			</if>
			<if test="inspecte_score !=null and inspecte_score !='' ">
				inspecte_score = #{inspecte_score}+IFNULL(inspecte_score,0)
			</if>
		</set>
		where user_id= #{user_id}
	</update>
	
	<select id="isExistUser" parameterType="String" resultType="int">
        SELECT
         COUNT(*)
        FROM APP_USER
        WHERE 1=1 
        	AND moble = #{moble}
            AND is_del = 0
    </select>
    
     <select id="getUserById" parameterType="HashMap" resultType="UserBean">
    	SELECT 
    		user_id,
    		password,
    		password_salt,
			moble,
 			email,
			nick_name,
			avatar,
    		sex,
    		qq,
    		account,
    		account_name,
    		registration_id,
    		platform,
    		brand,
    		occupation,
   			birthday,
   			marital_status
    	FROM APP_USER
    	WHERE is_del = 0
    		<if test="user_id !=null and user_id !='' ">
				AND user_id = #{user_id} 
			</if>
			<if test="moble !=null and moble !='' ">
				AND moble = #{moble} 
			</if>
    </select>
    
	<select id="getCreidtByUser" parameterType="HashMap" resultType="CreditDataBean" >
		SELECT
		  xcd.user_id,
		  xcd.occupation,
		  xcd.task_finish,
		  xcd.task_upload,
		  xcd.task_qualified,
		  xcd.task_quility,
		  xcd.task_abandon,
		  xcd.task_overdue,
		  xcd.score,
		  xcd.total
		FROM APP_CREDIT_DATA xcd
		WHERE xcd.user_id = #{user_id} AND xcd.task_biz = #{task_biz}
	</select>
	
	<!-- 更新授权信息 包含身份证，姓名-->
	<update id="updateZhimaScore" parameterType="UserZhimaBean">
		UPDATE app_user_zhima auz,app_user au SET score = #{score},open_id=#{open_id},is_authorized=#{is_authorized} WHERE auz.user_id =au.user_id AND au.moble = #{moble}
	</update>
	
	<!-- 根据手机号获取是否存在授权信息-->
	<select id="getZhimaAuthoried" parameterType="String" resultType="UserZhimaBean">
		SELECT
		   auz.zhima_id,auz.cert_no,auz.name,auz.user_id,auz.open_id,au.moble
		FROM app_user_zhima auz,app_user au
		WHERE auz.user_id = au.user_id AND au.moble = #{moble}
		LIMIT 0,1
	</select>
	
	<select id="getZhimaAuthorizedUserCount" parameterType="UserSearch" resultType="int">
		select count(1)
		from app_user_zhima auz
		left join app_user au on auz.user_id = au.user_id
		<where>
			<if test=" nick_name_search != null and nick_name_search !='' ">
				au.nick_name like concat("%",#{nick_name_search},"%") and
			</if>
			<if test=" moble_search != null and moble_search !='' ">
				au.moble = #{moble_search} and
			</if>
			<if test=" is_authorized != null and is_authorized !='' ">
				auz.is_authorized = #{is_authorized} and
			</if>
			1=1
		</where>
	</select>
	
	<select id="getZhimaAuthorizedUserList" parameterType="UserSearch" resultType="UserZhimaBean">
		select auz.zhima_id,auz.user_id,auz.score,auz.is_authorized,auz.create_time,auz.update_time,
				au.nick_name,au.moble,au.nick_name
		from app_user_zhima auz
		left join app_user au on auz.user_id = au.user_id
		<where>
			<if test=" nick_name_search != null and nick_name_search !='' ">
				au.nick_name like concat("%",#{nick_name_search},"%") and
			</if>
			<if test=" moble_search != null and moble_search !='' ">
				au.moble = #{moble_search} and
			</if>
			<if test=" is_authorized != null and is_authorized !='' ">
				auz.is_authorized = #{is_authorized} and
			</if>
			1=1
		</where>
		order by auz.create_time
		<if test="havePage == 1">
            limit #{start},#{rows}
        </if> 
	</select>
	
</mapper>