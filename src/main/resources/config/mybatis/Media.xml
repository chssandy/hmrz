<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hmrz.mybatis.media">
	<select id="getMediaList"  parameterType="MediaSearch" resultType="MediaListBean">
		SELECT
		  sm.task_id,
		  sm.name,
		  cv.vendor_name,
		  stt.name AS task_type_name,
		  cc.moble as create_user,
		  xm.manager_name as agent,
		  sm.execute_times,
		  sm.salary,
		  sm.plat_fee,
		  sm.do_btime,
		  sm.do_etime,
		  sm.status,
		  sm.remark,
		  sm.reject_reason,
		  sm.audit_times,
		  sm.vendor_id
		FROM s_media sm
		  LEFT JOIN c_vendor cv ON sm.vendor_id = cv.vendor_id
		  LEFT JOIN s_task_type stt ON sm.task_type_id = stt.task_type_id
		  LEFT JOIN c_customer cc ON sm.create_user = cc.customer_id 
		  LEFT JOIN xt_manager xm ON sm.agent = xm.manager_id
	    <where>
	   		<if test="task_id != null and task_id != ''">
				sm.task_id = #{task_id} AND
			</if>
	    	<if test="name != null and name != ''">
				sm.name LIKE CONCAT('%',#{name},'%') AND
			</if>
			<if test="task_type_id !=null and task_type_id !='' and task_type_id != '-1' ">
				sm.task_type_id = #{task_type_id} AND
			</if>
			<if test="status !=null and status !='' and status != '-1' ">
				sm.status = #{status} AND
			</if>
			<if test="vendor_name != null and vendor_name != ''">
				cv.vendor_name LIKE CONCAT("%",#{vendor_name},"%")  AND
			</if>
			<if test="create_btime != null and create_btime != ''">
                 sm.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00') AND
            </if>
            <if test="create_etime != null and create_etime != ''">
                 sm.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59') AND
            </if>
			sm.is_del = 0 and stt.father_id = #{father_id} AND (sm.create_type &lt;&gt; 1 OR (sm.create_type = 1 AND sm.status &lt;&gt; 0 ))
			<!-- 需要上线审核的任务is_desc 为升序  -->
			<if test='is_desc == "1"'>
		    	AND sm.status = 1
		    </if>
		</where>
	    ORDER BY sm.create_time 
	    <if test='is_desc == "0"'>
	    	DESC
	    </if>
	    <if test="havePage == 1">
            LIMIT #{start},#{rows}
        </if>
	</select>
	
	<select id="getMediaCount" parameterType="MediaSearch" resultType="int" >
		select 	count(1) from s_media sm
		LEFT JOIN c_vendor cv ON sm.vendor_id = cv.vendor_id 
		LEFT JOIN s_task_type stt ON sm.task_type_id = stt.task_type_id
	    <where>
	   		<if test="task_id != null and task_id != ''">
				sm.task_id = #{task_id} and
			</if>
	    	<if test="name != null and name != ''">
				sm.name LIKE CONCAT('%',#{name},'%') and
			</if>
			<if test="task_type_id !=null and task_type_id !='' and task_type_id != '-1' ">
				sm.task_type_id = #{task_type_id} and
			</if>
			<if test="status !=null and status !='' and status != '-1' ">
				sm.status = #{status} and
			</if>
			<if test="vendor_name != null and vendor_name != ''">
				cv.vendor_name LIKE CONCAT("%",#{vendor_name},"%")  AND
			</if>
			<if test="create_btime != null and create_btime != ''">
                sm.create_time &gt;= CONCAT(#{create_btime}, ' 00:00:00') AND
            </if>
            <if test="create_etime != null and create_etime != ''">
                sm.create_time &lt;= CONCAT(#{create_etime}, ' 23:59:59') AND
            </if>
				sm.is_del = 0 and stt.father_id = #{father_id} AND (sm.create_type &lt;&gt; 1 OR (sm.create_type = 1 AND sm.status &lt;&gt; 0 ))
			<!-- 需要上线审核的任务is_desc 为升序  -->
			<if test='is_desc == "1"'>
		    	AND sm.status = 1
		    </if>
		</where>
	</select>
	
	
	<insert id="addMedia" parameterType="MediaBean"  useGeneratedKeys="true" keyProperty="task_id" >
		insert into s_media(name,descript,task_type_id,salary,execute_times,do_btime,do_etime,publish_user,publish_time,audit_times,
					plat_fee,status,vendor_id,remark,agent,create_user,create_type,is_exclusive)
			values(#{name},#{descript},#{task_type_id},#{salary},#{execute_times},#{do_btime},#{do_etime},#{publish_user},#{publish_time},#{audit_times},
					#{plat_fee},#{status},#{vendor_id},#{remark},#{agent},#{create_user},#{create_type},#{is_exclusive} )				
	</insert>
	
	
	<update id="updateMedia" parameterType="MediaBean">
		update s_media sm left join s_media_restrain smr on sm.task_id = smr.task_id
		<set>
			sm.name = #{name},
			sm.descript = #{descript},
			sm.salary = #{salary},
			sm.plat_fee = #{plat_fee},
			sm.execute_times = #{execute_times},
			sm.do_btime = #{do_btime},
			sm.do_etime = #{do_etime},
			sm.audit_times = #{audit_times},
			sm.is_exclusive = #{is_exclusive},
			smr.one_executor_times = #{trb.one_executor_times},
			smr.water_marker = #{trb.water_marker},
			smr.group_id = #{trb.group_id},
			smr.sex = #{trb.sex}
		</set>	
		where sm.task_id = #{task_id} and sm.vendor_id = #{vendor_id}
	</update>
	
	<update id="updateTaskRemark" parameterType="MediaBean" >
		update s_media set remark = #{remark} where task_id = #{task_id}
	</update>
	
	<delete id="deleteMediaExt" parameterType="string">
		delete smt,smo,smc,smp 
		from s_media sm
	    left join s_media_topic smt on sm.task_id = smt.task_id
	    left join s_media_option smo on sm.task_id = smo.task_id
	    left join s_media_city smc on sm.task_id = smc.task_id
	    left join s_media_pt smp on sm.task_id = smp.task_id
		where sm.task_id = #{task_id} 
	</delete>
	
	<delete id="deleteMedia" parameterType="HashMap">
		delete sm,smr,smt,smo,smc,smp from s_media sm
	    left join s_media_restrain smr on sm.task_id = smr.task_id
	    left join s_media_topic smt on sm.task_id = smt.task_id
	    left join s_media_option smo on sm.task_id = smo.task_id
	    left join s_media_city smc on sm.task_id = smc.task_id
	    left join s_media_pt smp on sm.task_id = smp.task_id
		where 
		sm.task_id = #{task_id} and sm.status = 0 
	</delete>
	
	<update id="publishMedia" parameterType="MediaBean">
		update s_media set status = #{status},publish_user = #{publish_user},publish_time = now()
		where task_id = #{task_id} 
	</update>
	
	<insert id="addMediaTopics" parameterType="HashMap">
		insert into s_media_topic(task_id,cid,sort,field_type,label,descript,required,img_url,skipto,answer_rules,execute_rule,execute_img) values
		<foreach collection="topicList" item="item" separator=","  index="index">
		 (#{task_id},#{item.cid},#{item.sort},#{item.field_type},#{item.label},#{item.descript},#{item.required},
		 	#{item.img_url},#{item.skipto},#{item.answer_rules},#{item.execute_rule},#{item.execute_img})
		</foreach>
	</insert>
	
	<insert id="addMediaTopic" parameterType="TaskTopicBean" useGeneratedKeys="true" keyProperty="topic_id">
		insert into s_media_topic(task_id,cid,sort,field_type,label,descript,required,img_url,skipto,answer_rules,execute_rule,execute_img) values
		 (#{task_id},#{cid},#{sort},#{field_type},#{label},#{descript},#{required},#{img_url},#{skipto},#{answer_rules},#{execute_rule},#{execute_img})
	</insert>
	
	<insert id="addMediaOptions" parameterType="HashMap" >
		insert into s_media_option(task_id,topic_id,option_title,option_value,checked,img_url,skipto) values
		<foreach collection="optionList" item="item" separator=","  index="index">
		 (#{task_id},#{item.topic_id},#{item.label},#{item.option_value},#{item.checked},#{item.img_url},#{item.skipto})
		</foreach>
	</insert>
	
	<insert id="addMediaRestrain" parameterType="TaskRestrainBean">
		insert into s_media_restrain(task_id,water_marker,one_executor_times,group_id,sex )
		values (#{task_id},#{water_marker},#{one_executor_times},#{group_id},#{sex} )
	</insert>
	
	<insert id="addMediaCity" parameterType="HashMap">
		insert into s_media_city (task_id,city_code,city_level) values
		<foreach collection="cities" item="item" separator=","  index="index">
		 (#{task_id},#{item.city_code},#{item.city_level})
		</foreach>
	</insert>
	
	<insert id="addMediaPoint" parameterType="HashMap">
		insert into s_media_pt (task_id,province_code,province_name,city_code,city_name,address) values
		<foreach collection="mediaPointList" item="item" separator=","  index="index">
		 (#{task_id},#{item.province_code},#{item.province_name},#{item.city_code},#{item.city_name},#{item.address})
		</foreach>
	</insert>
	
	<select id="checkPointExist" parameterType="TaskPointBean" resultType="TaskPointBean">
		select province_code,city_code,province_name,city_name from xt_city where province_name = #{province_name} and city_name = #{city_name} and city_level = 4
	</select>
	
	<select id="getMediaById" parameterType="HashMap" resultMap="MediaInfo">
	  select sm.task_id,sm.name,sm.descript,sm.task_type_id,sm.salary,sm.execute_times,sm.vendor_id,sm.create_user,
	  		 DATE_FORMAT(sm.do_btime,'%Y-%m-%d %H:%i') as do_btime,DATE_FORMAT(sm.do_etime,'%Y-%m-%d %H:%i') as do_etime,sm.audit_times,
			 smr.one_executor_times,smr.water_marker,smr.group_id,smr.sex,
			 stt.name task_type_name,
			 smt.cid,smt.sort,smt.field_type,smt.label,smt.descript description,smt.required,smt.img_url,smt.skipto,smt.answer_rules,smt.execute_rule,smt.execute_img,
			 smo.option_title,smo.option_value,smo.checked,smo.img_url image,smo.skipto skip_to
		from s_media sm
		left join s_task_type stt on sm.task_type_id = stt.task_type_id
		left join s_media_restrain smr on sm.task_id = smr.task_id
		left join s_media_topic smt on sm.task_id = smt.task_id
		left join s_media_option smo on smt.topic_id = smo.topic_id
		where sm.task_id = #{task_id}  and sm.is_del=0
	</select>
	
	<resultMap type="MediaBean" id="MediaInfo">
		<id column="task_id" property="task_id"></id>
		<result column="name" property="name" />
		<result column="descript" property="descript" />
		<result column="task_type_id" property="task_type_id" />
		<result column="task_type_name" property="task_type_name" />
		<result column="salary" property="salary" />
		<result column="execute_times" property="execute_times" />
		<result column="do_btime" property="do_btime" />
		<result column="do_etime" property="do_etime" />
		<result column="audit_times" property="audit_times"/>
		<result column="vendor_id" property="vendor_id"/>
		<result column="create_user" property="create_user"/>
		<association property="trb" javaType="TaskRestrainBean" >
			<result column="one_executor_times" property="one_executor_times"/>
			<result column="water_marker" property="water_marker"/>
			<result column="group_id" property="group_id"/>
			<result column="sex" property="sex"/>
		</association>
		<collection property="topicList" ofType="TaskTopicBean">
			<result column="cid" property="cid"/>
			<result column="sort" property="sort"/>
			<result column="field_type" property="field_type"/>
			<result column="label" property="label"/>
			<result column="description" property="descript"/>
			<result column="required" property="required"/>
			<result column="img_url" property="img_url"/>
			<result column="skipto" property="skipto"/>
			<result column="answer_rules" property="answer_rules"/>
			<result column="execute_rule" property="execute_rule"/>
			<result column="execute_img" property="execute_img"/>
			<collection property="options" ofType="TaskOptionBean">
				<result column="option_title" property="label" />
				<result column="option_value" property="option_value" />
				<result column="checked" property="checked" />
				<result column="image" property="img_url" />
				<result column="skip_to" property="skipto" />
			</collection>
		</collection>
	</resultMap>
	
	<select id="getMediaPointList" parameterType="string" resultType="TaskPointBean">
		select task_pt_id,task_id,province_code,province_name,city_code,city_name,address from s_media_pt where task_id = #{task_id}
	</select>
	
	<select id="getMediaCityList" parameterType="string" resultType="CityBean">
		select smc.city_code,smc.city_level from s_media_city smc where task_id = #{task_id}
	</select>
	
	<select id="getTaskMainInfo" parameterType="String" resultType="MediaBean">
		select task_id,name,vendor_id,create_user,agent
		from s_media
		where task_id = #{task_id}
	</select>
	
</mapper>