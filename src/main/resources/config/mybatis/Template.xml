<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hmrz.mybatis.template">

	<select id="getTemplateList"  parameterType="TemplateSearch" resultType="TemplateBean">
		select st.template_id,st.template_name,st.task_type_id,stt.name task_type_name,xm.moble create_user,st.create_time,st.is_open,st.status
 		from s_template st	
		left join s_task_type stt on st.task_type_id = stt.task_type_id
		left join xt_manager xm on st.create_user = xm.manager_id
		where st.task_biz = #{task_biz}
	    ORDER BY st.create_time DESC
	    <if test="havePage == 1">
            LIMIT #{start},#{rows}
        </if>
	</select>
	
	<select id="getTemplateCount" parameterType="TemplateSearch" resultType="int" >
		select 	count(1) from s_template st where st.task_biz = #{task_biz}
	</select>
	
	<insert id="addTemplate" parameterType="TemplateBean"  useGeneratedKeys="true" keyProperty="template_id" >
		insert into s_template(template_name,descript,task_type_id,task_biz,create_user,create_type,status,is_open)
			values(#{template_name},#{descript},#{task_type_id},#{task_biz},#{create_user},#{create_type},#{status},#{is_open})				
	</insert>
	
	<update id="updateTemplate" parameterType="TemplateBean">
		update s_template st
		<set>
			st.template_name = #{template_name},
			st.descript = #{descript},
			st.task_biz = #{task_biz},
			st.task_type_id = #{task_type_id},
			st.is_open = #{is_open}
		</set>	
		where st.template_id = #{template_id} 
	</update>
	
	<delete id="deleteTemplateExt" parameterType="string">
		delete stt,sto 
		from s_template st
	    left join s_template_topic stt on st.template_id = stt.template_id
	    left join s_template_option sto on st.template_id = sto.template_id
		where st.template_id = #{template_id} 
	</delete>
	
	<delete id="deleteTemplate" parameterType="String">
		delete st,stt,sto 
		from s_template st
	    left join s_template_topic stt on st.template_id = stt.template_id
	    left join s_template_option sto on st.template_id = sto.template_id
		where st.template_id = #{template_id} 
	</delete>
	
	<update id="publishTemplate" parameterType="HashMap">
		update s_template  set status = #{status} where template_id = #{template_id} 
	</update>
	
	<insert id="addTemplateTopics" parameterType="HashMap">
		insert into s_template_topic(template_id,cid,sort,field_type,label,descript,required,img_url,skipto,answer_rules,execute_rule,execute_img) values
		<foreach collection="topicList" item="item" separator=","  index="index">
		 (#{template_id},#{item.cid},#{item.sort},#{item.field_type},#{item.label},#{item.descript},#{item.required},
		 	#{item.img_url},#{item.skipto},#{item.answer_rules},#{item.execute_rule},#{item.execute_img})
		</foreach>
	</insert>
	
	<insert id="addTemplateTopic" parameterType="TaskTopicBean" useGeneratedKeys="true" keyProperty="topic_id">
		insert into s_template_topic(template_id,cid,sort,field_type,label,descript,required,img_url,skipto,answer_rules,execute_rule,execute_img) values
		 (#{task_id},#{cid},#{sort},#{field_type},#{label},#{descript},#{required},#{img_url},#{skipto},#{answer_rules},#{execute_rule},#{execute_img})
	</insert>
	
	<insert id="addTemplateOptions" parameterType="HashMap" >
		insert into s_template_option(template_id,topic_id,option_title,option_value,checked,img_url,skipto) values
		<foreach collection="optionList" item="item" separator=","  index="index">
		 (#{template_id},#{item.topic_id},#{item.label},#{item.option_value},#{item.checked},#{item.img_url},#{item.skipto})
		</foreach>
	</insert>
	
	<select id="getTemplateById" parameterType="String" resultMap="TemplateInfo">
	  select ss.template_id,ss.template_name,ss.descript,ss.task_type_id,ss.task_biz,ss.is_open,
			 sst.cid,sst.sort,sst.field_type,sst.label,sst.descript description,sst.required,sst.img_url,sst.skipto,sst.answer_rules,sst.execute_rule,sst.execute_img,
			 sso.option_title,sso.option_value,sso.checked,sso.img_url image,sso.skipto skip_to
		from s_template ss
		left join s_template_topic sst on ss.template_id = sst.template_id
		left join s_template_option sso on sst.topic_id = sso.topic_id
		where ss.template_id = #{template_id} and ss.is_del=0
	</select>
	
	<resultMap type="TemplateBean" id="TemplateInfo">
		<id column="template_id" property="template_id"></id>
		<result column="descript" property="descript" />
		<result column="template_name" property="template_name" />
		<result column="task_type_id" property="task_type_id" />
		<result column="task_biz" property="task_biz" />
		<result column="is_open" property="is_open" />
		<collection property="topicList" ofType="TaskTopicBean">
			<result column="cid" property="cid"/>
			<result column="sort" property="sort"/>
			<result column="field_type" property="field_type"/>
			<result column="label" property="label"/>
			<result column="description" property="descript"/>
			<result column="required" property="required"/>
			<result column="img_url" property="img_url"/>
			<result column="skipto" property="skipto"/>
			<result column="answer_rules" property="answer_rules"/>
			<result column="execute_rule" property="execute_rule"/>
			<result column="execute_img" property="execute_img"/>
			<collection property="options" ofType="TaskOptionBean">
				<result column="option_title" property="label" />
				<result column="option_value" property="option_value" />
				<result column="checked" property="checked" />
				<result column="image" property="img_url" />
				<result column="skip_to" property="skipto" />
			</collection>
		</collection>
	</resultMap>
	
</mapper>